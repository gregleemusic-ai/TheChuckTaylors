<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Chuck Taylors ‚Äî Gigs</title>
  <meta name="theme-color" content="#ff6b35" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
  
    body{font-family:Inter,system-ui,sans-serif;background:#0d1117;color:#e5e7eb}
    .card{background:rgba(255,255,255,.06);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:14px}
    .btn{background:#ff6b35;color:#0d1117;font-weight:700;border-radius:10px;padding:.6rem .9rem;cursor:pointer;border:none}
    .btn-sec{background:transparent;border:1px solid #ff6b35;color:#ff6b35;border-radius:10px;padding:.5rem .8rem;cursor:pointer}
    .btn:hover{background:#ff8555}
    .btn-sec:hover{background:rgba(255,107,53,.1)}
    a.link{color:#ffd23f;text-decoration:underline}
    input,select,textarea{background:#0b1220;border:1px solid #2b3547;border-radius:10px;padding:.55rem .7rem;width:100%;color:#e5e7eb}
    label{font-size:.9rem;color:#cbd5e1}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:.8rem}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.8rem}
    .hidden{display:none}
    .subtle{color:#a3b0c2}
    .pill{display:inline-block;font-size:.75rem;padding:.25rem .5rem;border:1px solid #2b3547;border-radius:999px}
    .kv{display:grid;grid-template-columns:180px 1fr;gap:.6rem}
    .chat-msg{background:rgba(255,255,255,.05);padding:.75rem;border-radius:8px;border-left:3px solid #ff6b35;margin-bottom:.5rem}
    .chat-user{font-weight:700;color:#ff6b35;font-size:.85rem}
    .chat-time{color:#a3b0c2;font-size:.7rem;margin-left:.5rem}
    .chat-text{margin-top:.3rem;font-size:.9rem}
    .ytd-card{background:rgba(255,107,53,.1);border:2px solid #ff6b35;border-radius:12px;padding:1rem;text-align:center}
    .ytd-name{font-size:.9rem;color:#cbd5e1;margin-bottom:.3rem}
    .ytd-amount{font-size:1.5rem;font-weight:700;color:#ff6b35}
    .payment-gig{background:rgba(255,255,255,.03);border:1px solid #2b3547;border-radius:8px;padding:1rem;margin-bottom:.75rem}
    .payment-status{display:inline-block;padding:.2rem .6rem;border-radius:6px;font-size:.75rem;font-weight:600}
    .payment-status.paid{background:#10b981;color:#fff}
    .payment-status.unpaid{background:#ef4444;color:#fff}

    dialog{border:none;padding:0;max-width:90vw;max-height:90vh;overflow:auto}
    dialog::backdrop{background:rgba(0,0,0,.7)}
    .modal{background:#1a1f2e !important;border:1px solid #2b3547 !important;color:#fff !important}
    .modal .subtle{color:#cbd5e1}

    .cal-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:2px;margin-top:.5rem}
    .cal-header{font-size:.75rem;font-weight:700;color:#cbd5e1;text-align:center;padding:.5rem;background:#1a1f2e}
    .cal-day{min-height:80px;background:#fff;color:#0d1117;padding:.5rem;border-radius:4px;position:relative;cursor:pointer;transition:all .2s}
    .cal-day:hover{transform:scale(1.02);box-shadow:0 4px 12px rgba(255,107,53,.3)}
    .cal-day.has-event{background:#ff6b35;color:#fff;font-weight:700}
    .cal-day.band-off{background:#dc2626 !important;color:#fff !important;font-weight:700}
    .cal-day.band-off .cal-event{background:rgba(255,255,255,.25)}
    .cal-day.other-month{opacity:.3}
    .cal-day-num{font-size:1.1rem;font-weight:700;margin-bottom:.25rem}
    .cal-day.today{border:3px solid #ffd23f}
    .cal-event{font-size:.7rem;background:rgba(0,0,0,.2);padding:.2rem .3rem;margin-top:.2rem;border-radius:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .cal-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">The Chuck Taylors ‚Äî Gigs</h1>
      <div class="flex items-center gap-3 text-sm text-slate-300">
        <button id="setPassBtn" class="btn-sec">üîí Set Passcode</button>
        <span id="lockStatus" class="text-xs subtle"></span>
      </div>
    </header>

    <!-- Control bar -->
    <div class="card p-3 md:p-4 mb-6">
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <div class="text-sm text-slate-300">
          <span>Gigs, chat, payments, charts, and YouTube links.</span>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          <button id="showGigsBtn" class="btn-sec">üìÖ Gigs</button>
          <button id="toggleChatBtn" class="btn-sec">üí¨ Chat</button>
          <button id="togglePaymentsBtn" class="btn-sec">üí∞ Payments</button>
          <button id="toggleChartsBtn" class="btn-sec">üìä Charts</button>
          <button id="toggleYouTubeBtn" class="btn-sec">üé¨ YouTUBE</button>
        </div>
      </div>
    </div>

    <!-- Gigs View -->
    <div id="gigsView">
      <div class="grid xl:grid-cols-3 gap-6">
        <div class="xl:col-span-2 card p-4 min-w-0">
          <div class="cal-nav">
            <button id="calPrev" class="btn-sec">‚Üê Prev</button>
            <h2 id="calTitle" class="text-2xl font-bold"></h2>
            <button id="calNext" class="btn-sec">Next ‚Üí</button>
          </div>
          <div class="flex gap-4 mb-3 text-sm flex-wrap">
            <div class="flex items-center gap-2"><div class="w-4 h-4 bg-white rounded"></div><span>Open Date</span></div>
            <div class="flex items-center gap-2"><div class="w-4 h-4 bg-orange-500 rounded"></div><span>Gig Scheduled</span></div>
            <div class="flex items-center gap-2"><div class="w-4 h-4 bg-red-600 rounded"></div><span>Band Off (Greg solo)</span></div>
            <div class="flex items-center gap-2"><div class="w-4 h-4 border-4 border-yellow-400 rounded"></div><span>Today</span></div>
          </div>
          <div id="monthlyCalendar"></div>
        </div>
        <div class="card p-4 min-w-0">
          <h2 class="text-xl font-bold mb-4">Upcoming Gigs</h2>
          <div id="gigsList" class="space-y-3"></div>
        </div>
      </div>
    </div>

    <!-- Chat Box -->
    <div id="chatView" class="hidden">
      <div class="card p-6">
        <h2 class="text-2xl font-bold mb-4">Band Chat</h2>
        <div id="chatMessages" class="bg-black bg-opacity-30 rounded-lg p-4 h-96 overflow-y-auto mb-4"></div>
        <div class="grid2">
          <input id="chatName" type="text" placeholder="Your name (optional)" />
          <div class="flex gap-2">
            <input id="chatInput" type="text" placeholder="Type a message..." />
            <button id="sendChat" class="btn">Send</button>
          </div>
        </div>
        <p class="text-xs text-slate-400 mt-2">Messages are stored only in this browser.</p>
      </div>
    </div>

    <!-- Payments Dashboard -->
    <div id="paymentsView" class="hidden">
      <div class="card p-6">
        <h2 class="text-2xl font-bold mb-4">Payment Tracking - YTD 2025</h2>
        <div id="ytdSummary" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6"></div>
        <h3 class="text-xl font-bold mb-3">Recent Gigs</h3>
        <div id="paymentsList"></div>
      </div>
    </div>

    <!-- Charts Repository -->
    <div id="chartsView" class="hidden">
      <div class="card p-6">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h2 class="text-2xl font-bold">Charts & PDFs</h2>
          <span class="pill">Public uploads</span>
        </div>

        <div class="mt-4 grid2">
          <div class="card p-4">
            <h3 class="text-xl font-semibold mb-2">Upload PDFs</h3>
            <p class="text-sm text-slate-400 mb-3">Stage plots, setlists, tech riders, song charts‚Ä¶ (PDF only)</p>
            <input id="pdfInput" type="file" accept="application/pdf" multiple />
            <div class="grid2 mt-3">
              <input id="pdfTitle" type="text" placeholder="Optional: title/notes" />
              <input id="uploaderName" type="text" placeholder="Your name (optional)" />
            </div>
            <div class="mt-3"><button id="uploadPdfBtn" class="btn">Upload</button></div>
          </div>

          <div class="card p-4">
            <h3 class="text-xl font-semibold mb-2">Find Files</h3>
            <div class="grid2">
              <input id="searchPdf" type="text" placeholder="Search by filename or notes..." />
              <select id="uploaderFilter"><option value="">All uploaders</option></select>
            </div>
            <div class="mt-3 flex gap-2 flex-wrap">
              <button id="clearFiltersBtn" class="btn-sec">Clear filters</button>
              <button id="exportRepoBtn" class="btn-sec">Export index (.json)</button>
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="text-xl font-bold mb-3">Repository</h3>
          <div id="pdfList" class="grid sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
          <div id="emptyRepo" class="text-slate-400 text-sm hidden">No files yet. Be the first to upload!</div>
        </div>
      </div>
    </div>

    <!-- YouTube Links Repository -->
    <div id="youtubeView" class="hidden">
      <div class="card p-6">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h2 class="text-2xl font-bold">YouTUBE Links</h2>
          <span class="pill">Public links</span>
        </div>

        <div class="mt-4 grid2">
          <div class="card p-4">
            <h3 class="text-xl font-semibold mb-2">Add a YouTube Link</h3>
            <p class="text-sm text-slate-400 mb-3">Paste a YouTube URL or 11-character video ID.</p>
            <input id="ytUrl" type="text" placeholder="https://www.youtube.com/watch?v=VIDEOID or VIDEOID" />
            <div class="grid2 mt-3">
              <input id="ytTitle" type="text" placeholder="Optional title" />
              <input id="ytNotes" type="text" placeholder="Optional notes" />
            </div>
            <div class="grid2 mt-3">
              <input id="ytUploader" type="text" placeholder="Your name (optional)" />
              <button id="addYtBtn" class="btn">Add Link</button>
            </div>
          </div>

          <div class="card p-4">
            <h3 class="text-xl font-semibold mb-2">Find Links</h3>
            <div class="grid2">
              <input id="ytSearch" type="text" placeholder="Search by title or notes..." />
              <select id="ytUploaderFilter"><option value="">All uploaders</option></select>
            </div>
            <div class="mt-3 flex gap-2 flex-wrap">
              <button id="ytClearFilters" class="btn-sec">Clear filters</button>
              <button id="ytExportBtn" class="btn-sec">Export index (.json)</button>
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="text-xl font-bold mb-3">Repository</h3>
          <div id="ytList" class="grid sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
          <div id="ytEmpty" class="text-slate-400 text-sm hidden">No links yet. Add your first!</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gig Detail Modal -->
  <dialog id="gigModal" class="card modal p-0" style="max-width:640px;">
    <div class="p-6">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold" id="gigTitle"></h3>
        <div class="flex gap-2">
          <button id="bandOffBtn" class="btn-sec hidden">Mark Band Off</button>
          <button id="clearBandOffBtn" class="btn-sec hidden">Clear Band Off</button>
          <button id="shareGigBtn" class="btn-sec">Share</button>
          <button id="closeGigModal" class="btn">Close</button>
        </div>
      </div>
      <div id="gigContent" class="space-y-2 text-sm"></div>
      <p id="shareHint" class="text-xs subtle mt-3 hidden">Link copied!</p>
    </div>
  </dialog>

  <!-- PDF Preview Modal -->
  <dialog id="pdfModal" class="card modal p-0" style="width:min(900px,95vw);height:min(90vh,900px);">
    <div class="p-4">
      <div class="flex items-center justify-between">
        <div>
          <h3 id="pdfModalTitle" class="text-xl font-bold">Preview</h3>
          <div id="pdfMeta" class="text-xs subtle mt-1"></div>
        </div>
        <div class="flex gap-2">
          <a id="pdfDownloadBtn" class="btn-sec" download>Download</a>
          <button id="closePdfModal" class="btn">Close</button>
        </div>
      </div>
      <div class="mt-3" style="height:75vh;">
        <object id="pdfObject" type="application/pdf" data="" width="100%" height="100%">
          <div class="text-sm text-slate-300 p-4">
            PDF preview not supported in this browser. Use the Download button instead.
          </div>
        </object>
      </div>
    </div>
  </dialog>

  <!-- YouTube Player Modal -->
  <dialog id="ytModal" class="card modal p-0" style="width:min(960px,95vw);">
    <div class="p-4">
      <div class="flex items-center justify-between">
        <h3 id="ytModalTitle" class="text-xl font-bold">YouTube</h3>
        <div class="flex gap-2">
          <button id="ytShareBtn" class="btn-sec">Share</button>
          <button id="ytCloseBtn" class="btn">Close</button>
        </div>
      </div>
      <div class="mt-3" style="aspect-ratio:16/9;">
        <iframe id="ytIframe" width="100%" height="100%" frameborder="0" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
      </div>
      <div id="ytMeta" class="text-xs subtle mt-2"></div>
      <p id="ytShareHint" class="text-xs subtle mt-2 hidden">Link copied!</p>
    </div>
  </dialog>

  <!-- Passcode Modal -->
  <dialog id="passModal" class="card modal p-0" style="max-width:420px;">
    <div class="p-5">
      <h3 class="text-lg font-bold mb-3">Set/Update Passcodes (optional)</h3>
      <div class="grid2">
        <input id="userPass" type="password" placeholder="Your passcode (this device)" />
        <input id="adminPass" type="password" placeholder="Admin passcode (Band Off)" />
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="savePassBtn" class="btn">Save</button>
        <button id="closePassBtn" class="btn-sec">Close</button>
      </div>
      <p class="text-xs subtle mt-2">Stored locally; not a cloud login.</p>
    </div>
  </dialog>

  <script>
  /* ===== Demo data (can be replaced with live) ===== */
  const BAND_MEMBERS = ['greg','john','tim','brian','mark'];
  const MEMBER_NAMES = { greg:'Greg', john:'John', tim:'Tim', brian:'Brian', mark:'Mark' };

  const DEMO_GIGS = [
    { id:1, title:'Sarah & Mike Wedding', date:'2025-11-15', startTime:'18:00', venue:'The Bell Event Centre', address:'312 Elm St, Cincinnati, OH',
      payments:{ greg:{amount:250,paid:true}, john:{amount:200,paid:true}, tim:{amount:200,paid:false}, brian:{amount:225,paid:true}, mark:{amount:200,paid:false} } },
    { id:2, title:'Jazz Night at The Blue Note', date:'2025-11-08', startTime:'20:00', venue:'The Blue Note', address:'456 Main St, Cincinnati, OH',
      payments:{ greg:{amount:180,paid:true}, john:{amount:150,paid:true}, tim:{amount:150,paid:true}, brian:{amount:165,paid:true}, mark:{amount:150,paid:true} } },
    { id:3, title:'Corporate Holiday Party', date:'2025-11-22', startTime:'19:00', venue:'Marriott Downtown', address:'11 W 5th St, Cincinnati, OH',
      payments:{ greg:{amount:300,paid:false}, john:{amount:250,paid:false}, tim:{amount:250,paid:false}, brian:{amount:275,paid:false}, mark:{amount:250,paid:false} } },
    { id:4, title:'Thanksgiving Eve Show', date:'2025-11-26', startTime:'21:00', venue:'The Riverfront Club', address:'789 River Rd, Cincinnati, OH',
      payments:{ greg:{amount:220,paid:false}, john:{amount:180,paid:false}, tim:{amount:180,paid:false}, brian:{amount:195,paid:false}, mark:{amount:180,paid:false} } },
    { id:5, title:'New Years Eve Party', date:'2025-12-31', startTime:'21:00', venue:'Cincinnati Music Hall', address:'1241 Elm St, Cincinnati, OH',
      payments:{ greg:{amount:400,paid:false}, john:{amount:350,paid:false}, tim:{amount:350,paid:false}, brian:{amount:375,paid:false}, mark:{amount:350,paid:false} } }
  ];

  const DEMO_CHAT = [
    { name:'Greg', message:'Great show last night everyone!', time:'2:30 PM' },
    { name:'John', message:'Thanks! That crowd was amazing', time:'2:35 PM' },
    { name:'Tim', message:'When is our next rehearsal?', time:'2:40 PM' },
    { name:'Greg', message:'Thursday at 7pm, my place', time:'2:42 PM' },
    { name:'Brian', message:'I\'ll bring the setlist', time:'2:45 PM' },
  ];

  /* ===== State ===== */
  let calendarDate = new Date();
  let chatMessages = JSON.parse(localStorage.getItem('ct_chat_v1')||'null') || [...DEMO_CHAT];

  // per-device id (for delete rights)
  const DEVICE_KEY = 'ct_device_id_v1';
  let deviceId = localStorage.getItem(DEVICE_KEY);
  if (!deviceId) { deviceId = (crypto.randomUUID && crypto.randomUUID()) || String(Math.random()).slice(2); localStorage.setItem(DEVICE_KEY, deviceId); }

  /* ===== Passcodes ===== */
  const PASS_KEYS = { user:'ct_user_pass_v1', admin:'ct_admin_pass_v1' };
  async function sha256(text){
    const data = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  async function setPasscodes({user, admin}){
    if (user) localStorage.setItem(PASS_KEYS.user, await sha256(user));
    if (admin) localStorage.setItem(PASS_KEYS.admin, await sha256(admin));
    updateLockStatus();
  }
  async function checkUserPass(){
    const stored = localStorage.getItem(PASS_KEYS.user);
    if (!stored) return true; // no pass set -> allow
    const tryPass = prompt('Enter your passcode to continue');
    if (!tryPass) return false;
    return stored === await sha256(tryPass);
  }
  async function requireAdmin(){
    const stored = localStorage.getItem(PASS_KEYS.admin);
    if (!stored){ alert('Admin passcode not set.'); return false; }
    const tryPass = prompt('Admin passcode required');
    if (!tryPass) return false;
    return stored === await sha256(tryPass);
  }
  function updateLockStatus(){
    const hasUser = !!localStorage.getItem(PASS_KEYS.user);
    const hasAdmin = !!localStorage.getItem(PASS_KEYS.admin);
    document.getElementById('lockStatus').textContent =
      `${hasUser?'Userüîí':'Userüîì'} ‚Ä¢ ${hasAdmin?'Adminüîí':'Adminüîì'}`;
    // Show admin buttons in modal if an admin pass exists locally
    const showAdmin = hasAdmin;
    document.getElementById('bandOffBtn').classList.toggle('hidden', !showAdmin);
    document.getElementById('clearBandOffBtn').classList.toggle('hidden', !showAdmin);
  }

  // Pass modal wiring
  const passModal = document.getElementById('passModal');
  document.getElementById('setPassBtn').onclick = ()=> passModal.showModal();
  document.getElementById('closePassBtn').onclick = ()=> passModal.close();
  document.getElementById('savePassBtn').onclick = async ()=>{
    const u = document.getElementById('userPass').value.trim();
    const a = document.getElementById('adminPass').value.trim();
    await setPasscodes({ user: u || null, admin: a || null });
    document.getElementById('userPass').value = '';
    document.getElementById('adminPass').value = '';
    passModal.close();
  };
  updateLockStatus();

  /* ===== Elements ===== */
  const showGigsBtn = document.getElementById('showGigsBtn');
  const toggleChatBtn = document.getElementById('toggleChatBtn');
  const togglePaymentsBtn = document.getElementById('togglePaymentsBtn');
  const toggleChartsBtn = document.getElementById('toggleChartsBtn');
  const toggleYouTubeBtn = document.getElementById('toggleYouTubeBtn');

  const gigsView = document.getElementById('gigsView');
  const chatView = document.getElementById('chatView');
  const paymentsView = document.getElementById('paymentsView');
  const chartsView = document.getElementById('chartsView');
  const youtubeView = document.getElementById('youtubeView');

  const calPrev = document.getElementById('calPrev');
  const calNext = document.getElementById('calNext');

  const chatMessagesEl = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const chatName = document.getElementById('chatName');
  const sendChat = document.getElementById('sendChat');

  const ytdSummary = document.getElementById('ytdSummary');
  const paymentsList = document.getElementById('paymentsList');

  // Charts repo
  const pdfInput = document.getElementById('pdfInput');
  const pdfTitle = document.getElementById('pdfTitle');
  const uploaderName = document.getElementById('uploaderName');
  const uploadPdfBtn = document.getElementById('uploadPdfBtn');
  const searchPdf = document.getElementById('searchPdf');
  const uploaderFilter = document.getElementById('uploaderFilter');
  const clearFiltersBtn = document.getElementById('clearFiltersBtn');
  const exportRepoBtn = document.getElementById('exportRepoBtn');
  const pdfList = document.getElementById('pdfList');
  const emptyRepo = document.getElementById('emptyRepo');

  const pdfModal = document.getElementById('pdfModal');
  const pdfObject = document.getElementById('pdfObject');
  const pdfModalTitle = document.getElementById('pdfModalTitle');
  const pdfMeta = document.getElementById('pdfMeta');
  const pdfDownloadBtn = document.getElementById('pdfDownloadBtn');
  const closePdfModal = document.getElementById('closePdfModal');

  // Gig modal
  const gigModal = document.getElementById('gigModal');
  const gigTitleEl = document.getElementById('gigTitle');
  const gigContent = document.getElementById('gigContent');
  const closeGigModal = document.getElementById('closeGigModal');
  const shareGigBtn = document.getElementById('shareGigBtn');
  const shareHint = document.getElementById('shareHint');
  const bandOffBtn = document.getElementById('bandOffBtn');
  const clearBandOffBtn = document.getElementById('clearBandOffBtn');

  // YouTube repo
  const ytUrl = document.getElementById('ytUrl');
  const ytTitle = document.getElementById('ytTitle');
  const ytNotes = document.getElementById('ytNotes');
  const ytUploader = document.getElementById('ytUploader');
  const addYtBtn = document.getElementById('addYtBtn');
  const ytSearch = document.getElementById('ytSearch');
  const ytUploaderFilter = document.getElementById('ytUploaderFilter');
  const ytClearFilters = document.getElementById('ytClearFilters');
  const ytExportBtn = document.getElementById('ytExportBtn');
  const ytList = document.getElementById('ytList');
  const ytEmpty = document.getElementById('ytEmpty');

  const ytModal = document.getElementById('ytModal');
  const ytModalTitle = document.getElementById('ytModalTitle');
  const ytIframe = document.getElementById('ytIframe');
  const ytMeta = document.getElementById('ytMeta');
  const ytCloseBtn = document.getElementById('ytCloseBtn');
  const ytShareBtn = document.getElementById('ytShareBtn');
  const ytShareHint = document.getElementById('ytShareHint');

  /* ===== View switching ===== */
  function hideAllViews(){ gigsView.classList.add('hidden'); chatView.classList.add('hidden'); paymentsView.classList.add('hidden'); chartsView.classList.add('hidden'); youtubeView.classList.add('hidden'); }
  function showGigsView(){ hideAllViews(); gigsView.classList.remove('hidden'); renderCalendar(); renderGigs(); }
  function showChatView(){ hideAllViews(); chatView.classList.remove('hidden'); renderChat(); }
  function showPaymentsView(){ hideAllViews(); paymentsView.classList.remove('hidden'); renderPayments(); }
  function showChartsView(){ hideAllViews(); chartsView.classList.remove('hidden'); hydrateUploaderFilter(); renderRepo(); }
  function showYouTubeView(){ hideAllViews(); youtubeView.classList.remove('hidden'); ytHydrateUploaderFilter(); ytRenderRepo(); }

  showGigsBtn.onclick = showGigsView;
  toggleChatBtn.onclick = showChatView;
  togglePaymentsBtn.onclick = showPaymentsView;
  toggleChartsBtn.onclick = showChartsView;
  toggleYouTubeBtn.onclick = showYouTubeView;

  /* ===== Calendar ===== */
  calPrev.onclick = ()=>{ calendarDate.setMonth(calendarDate.getMonth()-1); renderCalendar(); };
  calNext.onclick = ()=>{ calendarDate.setMonth(calendarDate.getMonth()+1); renderCalendar(); };

  function renderCalendar(){
    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth();
    const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    document.getElementById('calTitle').textContent = `${monthNames[month]} ${year}`;
    const calendar = document.getElementById('monthlyCalendar');
    calendar.innerHTML = '';
    const grid = document.createElement('div'); grid.className='cal-grid';
    dayNames.forEach(d=>{ const h=document.createElement('div'); h.className='cal-header'; h.textContent=d; grid.appendChild(h); });

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month+1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    const today = new Date();
    const isCurrentMonth = today.getFullYear()===year && today.getMonth()===month;
    const todayDate = today.getDate();

    const monthEvents = {};
    DEMO_GIGS.forEach(g=>{
      const d = new Date(g.date);
      if (d.getFullYear()===year && d.getMonth()===month){
        const day = d.getDate();
        if (!monthEvents[day]) monthEvents[day]=[];
        monthEvents[day].push(g);
      }
    });

    // prev month days
    for (let i=firstDay-1; i>=0; i--){
      const day = daysInPrevMonth - i;
      const cell = document.createElement('div'); cell.className='cal-day other-month';
      cell.innerHTML = `<div class="cal-day-num">${day}</div>`;
      grid.appendChild(cell);
    }
    // current month
    for (let day=1; day<=daysInMonth; day++){
      const cell = document.createElement('div'); cell.className='cal-day';
      const gigsToday = monthEvents[day] || [];
      const hasBandOff = gigsToday.some(g => g.bandOff === true);
      const hasAnyGig  = gigsToday.length > 0;

      if (hasBandOff) cell.classList.add('band-off');
      else if (hasAnyGig) cell.classList.add('has-event');

      if (isCurrentMonth && day===todayDate) cell.classList.add('today');

      let html = `<div class="cal-day-num">${day}</div>`;
      gigsToday.forEach(g=> {
        const label = g.bandOff ? 'Band Off' : g.title;
        html += `<div class="cal-event">${g.startTime} ${label}</div>`;
      });
      cell.innerHTML = html;

      if (gigsToday.length) cell.onclick = ()=> showGigDetail(gigsToday[0].id);
      grid.appendChild(cell);
    }
    // next month padding
    const total = firstDay + daysInMonth;
    const rem = total % 7 === 0 ? 0 : 7 - (total % 7);
    for (let day=1; day<=rem; day++){
      const cell = document.createElement('div'); cell.className='cal-day other-month';
      cell.innerHTML = `<div class="cal-day-num">${day}</div>`;
      grid.appendChild(cell);
    }
    calendar.appendChild(grid);
  }

  function renderGigs(){
    const gigsList = document.getElementById('gigsList');
    gigsList.innerHTML = '';
    const sorted = [...DEMO_GIGS].sort((a,b)=> new Date(a.date) - new Date(b.date));
    sorted.forEach(g=>{
      const div = document.createElement('div');
      const bandOffPill = g.bandOff ? `<span class="pill" style="border-color:#dc2626;color:#fff;background:#dc2626">Band Off</span>` : '';
      div.className='p-3 card cursor-pointer hover:bg-white hover:bg-opacity-10 transition-all';
      div.innerHTML = `
        <div>
          <div class="text-sm subtle">${g.date} ‚Ä¢ ${g.startTime}</div>
          <div class="font-semibold">${g.title} ${bandOffPill}</div>
          <div class="text-xs text-slate-400">${g.venue}</div>
          <button class="btn-sec mt-2 text-xs" onclick="showGigDetail(${g.id})">View Details</button>
          <button class="btn-sec mt-2 text-xs" onclick="shareGig(${g.id})">Share</button>
        </div>`;
      gigsList.appendChild(div);
    });
  }

  // Gig modal + sharable links + admin tagging
  window.showGigDetail = function(id, pushHash = true){
    const g = DEMO_GIGS.find(x=> x.id===id); if(!g) return;
    gigTitleEl.textContent = g.title;
    const badge = g.bandOff
      ? `<div class="mb-3 text-sm" style="background:#dc2626;color:#fff;padding:.4rem .6rem;border-radius:8px;display:inline-block">Band Off (Greg solo)</div>`
      : '';
    gigContent.innerHTML = `
      ${badge}
      <div class="kv"><div class="subtle">Date</div><div>${g.date} at ${g.startTime}</div></div>
      <div class="kv"><div class="subtle">Venue</div><div>${g.venue}</div></div>
      <div class="kv"><div class="subtle">Address</div><div>${g.address}</div></div>`;

    shareGigBtn.onclick = ()=> shareGig(id);
    bandOffBtn.onclick = ()=> markBandOff(id);
    clearBandOffBtn.onclick = ()=> clearBandOff(id);

    // Toggle admin buttons based on local admin pass
    const hasAdmin = !!localStorage.getItem(PASS_KEYS.admin);
    bandOffBtn.classList.toggle('hidden', !hasAdmin || g.bandOff === true);
    clearBandOffBtn.classList.toggle('hidden', !hasAdmin || g.bandOff !== true);

    shareHint.classList.add('hidden');
    gigModal.showModal();
    if (pushHash) location.hash = `gig-${id}`;
  };
  function shareGig(id){
    const url = `${location.origin}${location.pathname}#gig-${id}`;
    navigator.clipboard?.writeText(url).then(()=>{
      shareHint.classList.remove('hidden');
      setTimeout(()=> shareHint.classList.add('hidden'), 1500);
    });
  }
  window.addEventListener('hashchange', handleHashOpen);
  function handleHashOpen(){
    const g = location.hash.match(/#gig-(\d+)/);
    const y = location.hash.match(/#yt-([a-z0-9-]+)/i);
    if (g){ const id = parseInt(g[1],10); showGigDetail(id, false); }
    if (y){ const id = y[1]; const item = ytGetRepo().find(x=> x.id===id); if (item) ytOpen(item, false); }
  }
  if (location.hash) handleHashOpen();
  closeGigModal.onclick = ()=> { gigModal.close(); if (location.hash.startsWith('#gig-')) history.replaceState(null,'',location.pathname+location.search); };

  async function markBandOff(gigId){
    if (!(await requireAdmin())) return;
    const idx = DEMO_GIGS.findIndex(g=> g.id===gigId);
    if (idx>=0){ DEMO_GIGS[idx].bandOff = true; renderCalendar(); renderGigs(); showGigDetail(gigId, false); }
  }
  async function clearBandOff(gigId){
    if (!(await requireAdmin())) return;
    const idx = DEMO_GIGS.findIndex(g=> g.id===gigId);
    if (idx>=0){ delete DEMO_GIGS[idx].bandOff; renderCalendar(); renderGigs(); showGigDetail(gigId, false); }
  }

  /* ===== Chat ===== */
  function renderChat(){
    chatMessagesEl.innerHTML = '';
    chatMessages.forEach(m=>{
      const div = document.createElement('div');
      div.className='chat-msg';
      div.innerHTML = `
        <div><span class="chat-user">${m.name||'Guest'}</span>
        <span class="chat-time">${m.time||''}</span></div>
        <div class="chat-text">${m.message}</div>`;
      chatMessagesEl.appendChild(div);
    });
    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
  }
  sendChat.onclick = ()=>{
    const msg = (chatInput.value||'').trim(); if(!msg) return;
    const name = (chatName.value||'Guest').trim();
    const time = new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    chatMessages.push({ name, message: msg, time });
    chatInput.value=''; localStorage.setItem('ct_chat_v1', JSON.stringify(chatMessages)); renderChat();
  };
  chatInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendChat.click(); });

  /* ===== Payments ===== */
  function renderPayments(){
    const totals = {};
    BAND_MEMBERS.forEach(m=>{
      totals[m] = DEMO_GIGS.reduce((sum,g)=> sum + (g.payments[m]?.amount || 0), 0);
    });
    ytdSummary.innerHTML = '';
    BAND_MEMBERS.forEach(m=>{
      const card = document.createElement('div');
      card.className='ytd-card';
      card.innerHTML = `
        <div class="ytd-name">${MEMBER_NAMES[m]}</div>
        <div class="ytd-amount">$${totals[m].toFixed(2)}</div>
        <div class="text-xs text-slate-400 mt-1">YTD 2025</div>`;
      ytdSummary.appendChild(card);
    });
    paymentsList.innerHTML='';
    DEMO_GIGS.forEach(g=>{
      const div = document.createElement('div'); div.className='payment-gig';
      let inner = '<div class="grid grid-cols-2 md:grid-cols-5 gap-2 mt-2">';
      BAND_MEMBERS.forEach(m=>{
        const p = g.payments[m];
        inner += `
          <div class="text-center">
            <div class="text-xs text-slate-400">${MEMBER_NAMES[m]}</div>
            <div class="font-bold">$${p.amount.toFixed(2)}</div>
            <div class="payment-status ${p.paid?'paid':'unpaid'}">${p.paid?'‚úì Paid':'Unpaid'}</div>
          </div>`;
      });
      inner += '</div>';
      div.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="font-bold">${g.title}</div>
            <div class="text-sm text-slate-400">${g.date} ‚Ä¢ ${g.venue}</div>
          </div>
        </div>${inner}`;
      paymentsList.appendChild(div);
    });
  }

  /* ===== Charts Repository ===== */
  const REPO_KEY = 'ct_pdf_repo_v2_public';
  function getRepo(){ try{ return JSON.parse(localStorage.getItem(REPO_KEY)) || []; }catch{ return []; } }
  function setRepo(arr){ localStorage.setItem(REPO_KEY, JSON.stringify(arr)); }

  function hydrateUploaderFilter(){
    const repo = getRepo();
    const names = Array.from(new Set(repo.map(f=> f.uploaderName || 'Guest')));
    uploaderFilter.innerHTML = '<option value="">All uploaders</option>';
    names.forEach(n=>{
      const opt = document.createElement('option');
      opt.value = n; opt.textContent = n;
      uploaderFilter.appendChild(opt);
    });
  }

  function renderRepo(){
    const q = (searchPdf.value||'').toLowerCase();
    const u = uploaderFilter.value || '';
    const repo = getRepo().sort((a,b)=> b.ts - a.ts);
    const filtered = repo.filter(item=>{
      const text = `${item.name} ${item.notes||''}`.toLowerCase();
      const matchesQ = !q || text.includes(q);
      const matchesU = !u || (item.uploaderName||'Guest') === u;
      return matchesQ && matchesU;
    });

    pdfList.innerHTML = '';
    emptyRepo.classList.toggle('hidden', filtered.length !== 0);

    filtered.forEach(item=>{
      const card = document.createElement('div');
      card.className = 'card p-4';
      const sizeKB = Math.round(item.size/1024);
      const when = new Date(item.ts).toLocaleString();
      const canDelete = item.deviceId === deviceId;

      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="font-semibold">${item.name}</div>
            <div class="text-xs text-slate-400 mt-1">
              ${item.notes ? `<span class="pill mr-2">${item.notes}</span>` : ''}
              <span class="pill">by ${item.uploaderName||'Guest'}</span>
              <span class="pill">${sizeKB} KB</span>
              <span class="pill">${when}</span>
            </div>
          </div>
          <div class="flex gap-2">
            <button class="btn-sec" data-act="view">View</button>
            <a class="btn-sec" data-act="download" download="${item.name}">Download</a>
            ${canDelete ? '<button class="btn-sec" data-act="delete">Delete</button>' : ''}
          </div>
        </div>`;
      const viewBtn = card.querySelector('[data-act="view"]');
      const dlBtn   = card.querySelector('[data-act="download"]');
      const delBtn  = card.querySelector('[data-act="delete"]');

      viewBtn.onclick = ()=> openPdfModal(item);
      dlBtn.href = item.dataUrl;
      if (delBtn){
        delBtn.onclick = async ()=>{
          if (!(await checkUserPass())) return alert('Wrong passcode.');
          const next = getRepo().filter(x=> x.id !== item.id);
          setRepo(next); hydrateUploaderFilter(); renderRepo();
        };
      }
      pdfList.appendChild(card);
    });
  }

  function openPdfModal(item){
    pdfModalTitle.textContent = item.name;
    pdfMeta.textContent = `${item.uploaderName||'Guest'} ‚Ä¢ ${(item.size/1024|0)} KB ‚Ä¢ ${new Date(item.ts).toLocaleString()}${item.notes? ' ‚Ä¢ '+item.notes:''}`;
    pdfObject.data = item.dataUrl;
    pdfDownloadBtn.href = item.dataUrl;
    pdfDownloadBtn.download = item.name;
    pdfModal.showModal();
  }
  closePdfModal.onclick = ()=> pdfModal.close();

  uploadPdfBtn.onclick = async ()=>{
    const files = Array.from(pdfInput.files||[]);
    if (!files.length){ alert('Select one or more PDF files.'); return; }
    const repo = getRepo();
    for (const f of files){
      if (f.type !== 'application/pdf'){ alert(`'${f.name}' is not a PDF.`); continue; }
      const dataUrl = await fileToDataUrl(f);
      const entry = {
        id: crypto.randomUUID(),
        name: f.name,
        size: f.size,
        notes: (pdfTitle.value||'').trim(),
        uploaderName: (uploaderName.value||'Guest').trim() || 'Guest',
        deviceId,
        ts: Date.now(),
        dataUrl
      };
      repo.push(entry);
    }
    setRepo(repo);
    pdfInput.value=''; pdfTitle.value='';
    hydrateUploaderFilter(); renderRepo();
  };

  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  searchPdf.addEventListener('input', renderRepo);
  uploaderFilter.addEventListener('change', renderRepo);
  clearFiltersBtn.onclick = ()=>{ searchPdf.value=''; uploaderFilter.value=''; renderRepo(); };
  exportRepoBtn.onclick = ()=>{
    const index = getRepo().map(({id,name,size,uploaderName,notes,ts})=>({id,name,size,uploaderName,notes,ts}));
    const blob = new Blob([JSON.stringify(index,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'charts_index.json'; a.click();
    URL.revokeObjectURL(url);
  };

  /* ===== YouTube Links Repository ===== */
  const YT_KEY = 'ct_yt_repo_v1';
  function ytGetRepo(){ try{ return JSON.parse(localStorage.getItem(YT_KEY)) || []; }catch{ return []; } }
  function ytSetRepo(arr){ localStorage.setItem(YT_KEY, JSON.stringify(arr)); }

  function parseYouTubeId(input){
    if (!input) return null;
    input = input.trim();
    if (/^[a-zA-Z0-9_-]{11}$/.test(input)) return input;
    const m =
      input.match(/(?:v=|\/embed\/|\/shorts\/|youtu\.be\/)([a-zA-Z0-9_-]{11})/) ||
      input.match(/v=([a-zA-Z0-9_-]{11})/);
    return m ? m[1] : null;
  }

  function ytHydrateUploaderFilter(){
    const repo = ytGetRepo();
    const names = Array.from(new Set(repo.map(f=> f.uploaderName || 'Guest')));
    ytUploaderFilter.innerHTML = '<option value="">All uploaders</option>';
    names.forEach(n=>{
      const opt = document.createElement('option');
      opt.value = n; opt.textContent = n;
      ytUploaderFilter.appendChild(opt);
    });
  }

  function ytRenderRepo(){
    const q = (ytSearch.value||'').toLowerCase();
    const u = ytUploaderFilter.value || '';
    const repo = ytGetRepo().sort((a,b)=> b.ts - a.ts);
    const filtered = repo.filter(item=>{
      const text = `${item.title||''} ${item.notes||''}`.toLowerCase();
      const matchesQ = !q || text.includes(q);
      const matchesU = !u || (item.uploaderName||'Guest') === u;
      return matchesQ && matchesU;
    });

    ytList.innerHTML = '';
    ytEmpty.classList.toggle('hidden', filtered.length !== 0);

    filtered.forEach(item=>{
      const thumb = `https://i.ytimg.com/vi/${item.videoId}/hqdefault.jpg`;
      const canDelete = item.deviceId === deviceId;

      const card = document.createElement('div');
      card.className = 'card p-3';
      card.innerHTML = `
        <div class="rounded overflow-hidden">
          <img src="${thumb}" alt="Thumbnail" class="w-full" loading="lazy">
        </div>
        <div class="mt-2 font-semibold">${item.title || 'YouTube Video'}</div>
        <div class="text-xs text-slate-400 mt-1">
          ${item.notes ? `<span class="pill mr-2">${item.notes}</span>` : ''}
          <span class="pill">by ${item.uploaderName||'Guest'}</span>
          <span class="pill">${new Date(item.ts).toLocaleString()}</span>
        </div>
        <div class="flex gap-2 mt-3 flex-wrap">
          <button class="btn-sec" data-act="play">Play</button>
          <a class="btn-sec" data-act="open" href="https://youtu.be/${item.videoId}" target="_blank" rel="noopener">Open</a>
          <button class="btn-sec" data-act="share">Share</button>
          ${canDelete ? '<button class="btn-sec" data-act="delete">Delete</button>' : ''}
        </div>`;

      const playBtn = card.querySelector('[data-act="play"]');
      const shareBtn = card.querySelector('[data-act="share"]');
      const delBtn = card.querySelector('[data-act="delete"]');

      playBtn.onclick = ()=> ytOpen(item);
      shareBtn.onclick = ()=> ytShare(item);
      if (delBtn){
        delBtn.onclick = async ()=>{
          if (!(await checkUserPass())) return alert('Wrong passcode.');
          ytSetRepo(ytGetRepo().filter(x=> x.id !== item.id));
          ytHydrateUploaderFilter(); ytRenderRepo();
        };
      }
      ytList.appendChild(card);
    });
  }

  function ytOpen(item, pushHash = true){
    ytModalTitle.textContent = item.title || 'YouTube';
    ytIframe.src = `https://www.youtube.com/embed/${item.videoId}?rel=0`;
    ytMeta.textContent = `${item.uploaderName||'Guest'} ‚Ä¢ ${new Date(item.ts).toLocaleString()}${item.notes? ' ‚Ä¢ '+item.notes:''}`;
    ytShareBtn.onclick = ()=> ytShare(item);
    ytShareHint.classList.add('hidden');
    ytModal.showModal();
    if (pushHash) location.hash = `yt-${item.id}`;
  }
  function ytShare(item){
    const url = `${location.origin}${location.pathname}#yt-${item.id}`;
    navigator.clipboard?.writeText(url).then(()=>{
      ytShareHint.classList.remove('hidden');
      setTimeout(()=> ytShareHint.classList.add('hidden'), 1500);
    });
  }
  ytCloseBtn.onclick = ()=>{
    ytIframe.src = '';
    ytModal.close();
    if (location.hash.startsWith('#yt-')) history.replaceState(null,'',location.pathname+location.search);
  };

  addYtBtn.onclick = ()=>{
    const id = parseYouTubeId(ytUrl.value);
    if (!id){ alert('Please enter a valid YouTube URL or 11-character video ID.'); return; }
    const repo = ytGetRepo();
    const item = {
      id: crypto.randomUUID(),
      videoId: id,
      title: (ytTitle.value||'').trim(),
      notes: (ytNotes.value||'').trim(),
      uploaderName: (ytUploader.value||'Guest').trim() || 'Guest',
      deviceId,
      ts: Date.now()
    };
    repo.push(item);
    ytSetRepo(repo);
    ytUrl.value=''; ytTitle.value=''; ytNotes.value='';
    ytHydrateUploaderFilter(); ytRenderRepo();
  };

  ytSearch.addEventListener('input', ytRenderRepo);
  ytUploaderFilter.addEventListener('change', ytRenderRepo);
  ytClearFilters.onclick = ()=>{ ytSearch.value=''; ytUploaderFilter.value=''; ytRenderRepo(); };
  ytExportBtn.onclick = ()=>{
    const index = ytGetRepo().map(({id,videoId,title,notes,uploaderName,ts})=>({id,videoId,title,notes,uploaderName,ts}));
    const blob = new Blob([JSON.stringify(index,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'youtube_index.json'; a.click();
    URL.revokeObjectURL(url);
  };

  /* ===== Init ===== */
  function init(){ renderCalendar(); renderGigs(); }
  init();
  </script>
</body>
</html>


