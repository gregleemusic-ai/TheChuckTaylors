<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Chuck Taylors ‚Äî Events</title>
  <meta name="theme-color" content="#ff6b35" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--accent:#ff6b35}
    body{font-family:Inter,system-ui,sans-serif;background:#0d1117;color:#e5e7eb}
    .card{background:rgba(255,255,255,.06);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:14px}
    .btn{background:var(--accent);color:#0d1117;font-weight:700;border-radius:10px;padding:.6rem .9rem;cursor:pointer;border:none}
    .btn-sec{background:transparent;border:1px solid var(--accent);color:var(--accent);border-radius:10px;padding:.5rem .8rem;cursor:pointer}
    .btn:hover{background:#ff8555}
    .btn-sec:hover{background:rgba(255,107,53,.1)}
    input,select,textarea{background:#0b1220;border:1px solid #2b3547;border-radius:10px;padding:.55rem .7rem;width:100%;color:#e5e7eb}
    textarea{min-height:84px}
    .subtle{color:#a3b0c2}
    .pill{display:inline-block;font-size:.75rem;padding:.25rem .5rem;border:1px solid #2b3547;border-radius:999px}
    .kv{display:grid;grid-template-columns:180px 1fr;gap:.6rem}
    .chat-msg{background:rgba(255,255,255,.05);padding:.75rem;border-radius:8px;border-left:3px solid var(--accent);margin-bottom:.5rem}
    .payment-gig{background:rgba(255,255,255,.03);border:1px solid #2b3547;border-radius:8px;padding:1rem;margin-bottom:.75rem}
    .payment-status{display:inline-block;padding:.2rem .6rem;border-radius:6px;font-size:.75rem;font-weight:600}
    .payment-status.paid{background:#10b981;color:#fff}
    .payment-status.unpaid{background:#ef4444;color:#fff}

    dialog{border:none;padding:0;max-width:90vw;max-height:90vh;overflow:auto}
    dialog::backdrop{background:rgba(0,0,0,.7)}
    .modal{background:#1a1f2e !important;border:1px solid #2b3547 !important;color:#fff !important}
    .modal .subtle{color:#cbd5e1}

    /* Calendar */
    .cal-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:2px;margin-top:.5rem}
    .cal-header{font-size:.75rem;font-weight:700;color:#cbd5e1;text-align:center;padding:.5rem;background:#1a1f2e}
    .cal-day{min-height:80px;background:#fff;color:#0d1117;padding:.5rem;border-radius:4px;position:relative;cursor:pointer;transition:all .2s}
    .cal-day:hover{transform:scale(1.02);box-shadow:0 4px 12px rgba(255,107,53,.3)}
    .cal-day.has-event{background:var(--accent);color:#fff;font-weight:700}
    .cal-day.band-off{background:#dc2626 !important;color:#fff !important;font-weight:700}
    .cal-day.band-off .cal-event{background:rgba(255,255,255,.25)}
    .cal-day.other-month{opacity:.3}
    .cal-day-num{font-size:1.1rem;font-weight:700;margin-bottom:.25rem}
    .cal-day.today{outline:3px solid #ffd23f;outline-offset:-3px}
    .cal-event{font-size:.7rem;background:rgba(0,0,0,.2);padding:.2rem .3rem;margin-top:.2rem;border-radius:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    /* Mobile buttons: same width */
    .nav-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
    @media (min-width:640px){ .nav-grid{display:flex;gap:.5rem} .nav-grid > *{width:auto} }
    .wfull-sm{width:100%} @media (min-width:640px){ .wfull-sm{width:auto} }
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">The Chuck Taylors ‚Äî Events</h1>
      <div class="flex items-center gap-2 flex-wrap text-sm text-slate-300">
        <button id="setPassBtn" class="btn-sec wfull-sm">üîí Set Passcode</button>
        <button id="adminLoginBtn" class="btn-sec wfull-sm">üë§ Admin Login</button>
        <button id="adminLogoutBtn" class="btn-sec hidden wfull-sm">‚Ü©Ô∏é Logout</button>
        <span id="lockStatus" class="text-xs subtle block w-full sm:w-auto sm:block"></span>
      </div>
    </header>

    <!-- Control bar -->
    <div class="card p-3 md:p-4 mb-6">
      <div class="flex flex-col gap-3">
        <div class="text-sm text-slate-300">Events, chat, payments, charts, and YouTube links.</div>
        <div class="nav-grid">
          <button id="showEventsBtn" class="btn-sec wfull-sm">üìÖ Dates</button>
          <button id="toggleChatBtn" class="btn-sec wfull-sm">üí¨ Chat</button>
          <button id="togglePaymentsBtn" class="btn-sec wfull-sm">üí∞ Payments</button>
          <button id="toggleChartsBtn" class="btn-sec wfull-sm">üìä Charts</button>
          <button id="toggleYouTubeBtn" class="btn-sec wfull-sm">üé¨ YouTube</button>
          <button id="addEventBtn" class="btn hidden wfull-sm">+ New Event</button>
        </div>
      </div>
    </div>

    <!-- Events View -->
    <div id="eventsView">
      <div class="grid xl:grid-cols-3 gap-6">
        <div class="xl:col-span-2 card p-4 min-w-0">
          <div class="flex items-center justify-center mb-3">
            <h2 id="calTitle" class="text-2xl font-bold text-center"></h2>
          </div>
          <div class="flex gap-4 mb-3 text-sm flex-wrap justify-center">
            <div class="flex items-center gap-2"><div class="w-4 h-4 bg-white rounded"></div><span>Open Date</span></div>
            <div class="flex items-center gap-2"><div class="w-4 h-4 bg-orange-500 rounded"></div><span>Event Scheduled</span></div>
            <div class="flex items-center gap-2"><div class="w-4 h-4 bg-red-600 rounded"></div><span>Band Off</span></div>
            <div class="flex items-center gap-2"><div class="w-4 h-4 border-4 border-yellow-400 rounded"></div><span>Today</span></div>
          </div>
          <div id="monthlyCalendar"></div>
        </div>
        <div class="card p-4 min-w-0">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold mb-4">Upcoming Dates</h2>
          </div>
          <div id="eventsList" class="space-y-3"></div>
        </div>
      </div>
    </div>

    <!-- Chat -->
    <div id="chatView" class="hidden">
      <div class="card p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold">Band Chat</h2>
          <button id="clearChatBtn" class="btn-sec hidden">üóëÔ∏è Clear Chat</button>
        </div>
        <div id="chatMessages" class="bg-black bg-opacity-30 rounded-lg p-4 h-96 overflow-y-auto mb-4"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <input id="chatName" type="text" placeholder="Your name (optional)" />
          <div class="flex gap-2">
            <input id="chatInput" type="text" placeholder="Type a message..." />
            <button id="sendChat" class="btn">Send</button>
          </div>
        </div>
        <p class="text-xs subtle mt-2">Messages are stored only in this browser.</p>
      </div>
    </div>

    <!-- Payments -->
    <div id="paymentsView" class="hidden">
      <div class="card p-6">
        <h2 class="text-2xl font-bold mb-4">Payment Tracking - YTD 2025</h2>
        <div id="ytdSummary" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6"></div>
        <h3 class="text-xl font-bold mb-3">Recent Events</h3>
        <div id="paymentsList"></div>
      </div>
    </div>

    <!-- Charts -->
    <div id="chartsView" class="hidden">
      <div class="card p-6">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h2 class="text-2xl font-bold">Charts & PDFs</h2>
          <span class="pill">Public uploads</span>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="card p-4">
            <h3 class="text-xl font-semibold mb-2">Upload PDFs</h3>
            <p class="text-sm subtle mb-3">Stage plots, setlists, tech riders, song charts‚Ä¶ (PDF only)</p>
            <input id="pdfInput" type="file" accept="application/pdf" multiple />
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-3">
              <input id="pdfTitle" type="text" placeholder="Optional: title/notes" />
              <input id="uploaderName" type="text" placeholder="Your name (optional)" />
            </div>
            <div class="mt-3"><button id="uploadPdfBtn" class="btn">Upload</button></div>
          </div>

          <div class="card p-4">
            <h3 class="text-xl font-semibold mb-2">Find Files</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
              <input id="searchPdf" type="text" placeholder="Search by filename or notes..." />
              <select id="uploaderFilter"><option value="">All uploaders</option></select>
            </div>
            <div class="mt-3 flex gap-2 flex-wrap">
              <button id="clearFiltersBtn" class="btn-sec">Clear filters</button>
              <button id="exportRepoBtn" class="btn-sec">Export index (.json)</button>
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="text-xl font-bold mb-3">Repository</h3>
          <div id="pdfList" class="grid sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
          <div id="emptyRepo" class="text-slate-400 text-sm hidden">No files yet. Be the first to upload!</div>
        </div>
      </div>
    </div>

    <!-- YouTube -->
    <div id="youtubeView" class="hidden">
      <div class="card p-6">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h2 class="text-2xl font-bold">YouTube Links</h2>
          <span class="pill">Public links</span>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="card p-4">
            <h3 class="text-xl font-semibold mb-2">Add a YouTube Link</h3>
            <p class="text-sm subtle mb-3">Paste a YouTube URL or 11-character video ID.</p>
            <input id="ytUrl" type="text" placeholder="https://www.youtube.com/watch?v=VIDEOID or VIDEOID" />
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-3">
              <input id="ytTitle" type="text" placeholder="Optional title" />
              <input id="ytNotes" type="text" placeholder="Optional notes" />
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-3">
              <input id="ytUploader" type="text" placeholder="Your name (optional)" />
              <button id="addYtBtn" class="btn">Add Link</button>
            </div>
          </div>

          <div class="card p-4">
            <h3 class="text-xl font-semibold mb-2">Find Links</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
              <input id="ytSearch" type="text" placeholder="Search by title or notes..." />
              <select id="ytUploaderFilter"><option value="">All uploaders</option></select>
            </div>
            <div class="mt-3 flex gap-2 flex-wrap">
              <button id="ytClearFilters" class="btn-sec">Clear filters</button>
              <button id="ytExportBtn" class="btn-sec">Export index (.json)</button>
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="text-xl font-bold mb-3">Repository</h3>
          <div id="ytList" class="grid sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
          <div id="ytEmpty" class="text-slate-400 text-sm hidden">No links yet. Add your first!</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Event Detail Modal (view/edit/delete + band off) -->
  <dialog id="gigModal" class="card modal p-0" style="max-width:720px;">
    <div class="p-6">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold" id="gigTitle"></h3>
        <div class="flex gap-2 flex-wrap">
          <button id="bandOffBtn" class="btn-sec hidden">Mark Band Off</button>
          <button id="clearBandOffBtn" class="btn-sec hidden">Clear Band Off</button>
          <button id="editGigBtn" class="btn-sec hidden">Edit</button>
          <button id="deleteGigBtn" class="btn-sec hidden">Delete</button>
          <button id="shareGigBtn" class="btn-sec">Share</button>
          <button id="closeGigModal" class="btn">Close</button>
        </div>
      </div>

      <!-- View mode -->
      <div id="gigView" class="space-y-2 text-sm"></div>

      <!-- Edit mode -->
      <div id="gigEdit" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label class="subtle text-xs">Title</label><input id="egTitle" /></div>
          <div><label class="subtle text-xs">Date</label><input id="egDate" type="date" /></div>
          <div><label class="subtle text-xs">Start Time</label><input id="egTime" type="time" /></div>
          <div><label class="subtle text-xs">Venue</label><input id="egVenue" /></div>
          <div class="md:col-span-2"><label class="subtle text-xs">Address</label><input id="egAddress" /></div>

          <label class="flex items-center gap-2 md:col-span-2"><input id="egBandOff" type="checkbox" /><span>Band Off (Greg solo)</span></label>

          <label class="flex items-center gap-2"><input id="egCeremonyOnsite" type="checkbox" /><span>Ceremony onsite?</span></label>
          <label class="flex items-center gap-2"><input id="egRoomFlip" type="checkbox" /><span>Room flip?</span></label>

          <div><label class="subtle text-xs">Guest Arrival</label><input id="egGuestArrivalTime" type="time" /></div>
          <div><label class="subtle text-xs">Band Arrival</label><input id="egBandArrivalTime" type="time" /></div>
          <div><label class="subtle text-xs">Time of Introduction</label><input id="egIntroTime" type="time" /></div>
          <div><label class="subtle text-xs">Song for Introduction</label><input id="egIntroSong" /></div>
          <div><label class="subtle text-xs">First Dance</label><input id="egFirstDanceSong" /></div>
          <div><label class="subtle text-xs">Parents' Dances</label><input id="egParentsDances" /></div>
          <div class="md:col-span-2"><label class="subtle text-xs">Special Requests</label><textarea id="egSpecialRequests"></textarea></div>
          <div><label class="subtle text-xs">Last Song</label><input id="egLastSong" /></div>
          <div class="md:col-span-2"><label class="subtle text-xs">Do-Not-Play Songs</label><textarea id="egDoNotPlay"></textarea></div>
        </div>
        <div class="flex justify-end gap-2 mt-4">
          <button id="saveGigBtn" class="btn">Save</button>
          <button id="cancelEditBtn" class="btn-sec">Cancel</button>
        </div>
      </div>

      <p id="shareHint" class="text-xs subtle mt-3 hidden">Link copied!</p>
    </div>
  </dialog>

  <!-- New Event Modal -->
  <dialog id="newGigModal" class="card modal p-0" style="max-width:720px;">
    <div class="p-6">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-bold">New Event</h3>
        <button id="closeNewGigModal" class="btn-sec">Close</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><label class="subtle text-xs">Title</label><input id="ngTitle" /></div>
        <div><label class="subtle text-xs">Date</label><input id="ngDate" type="date" /></div>
        <div><label class="subtle text-xs">Start Time</label><input id="ngTime" type="time" /></div>
        <div><label class="subtle text-xs">Venue</label><input id="ngVenue" /></div>
        <div class="md:col-span-2"><label class="subtle text-xs">Address</label><input id="ngAddress" /></div>

        <label class="flex items-center gap-2 md:col-span-2"><input id="ngBandOff" type="checkbox" /><span>Band Off (Greg solo)</span></label>

        <label class="flex items-center gap-2"><input id="ngCeremonyOnsite" type="checkbox" /><span>Ceremony onsite?</span></label>
        <label class="flex items-center gap-2"><input id="ngRoomFlip" type="checkbox" /><span>Room flip?</span></label>

        <div><label class="subtle text-xs">Guest Arrival</label><input id="ngGuestArrivalTime" type="time" /></div>
        <div><label class="subtle text-xs">Band Arrival</label><input id="ngBandArrivalTime" type="time" /></div>
        <div><label class="subtle text-xs">Time of Introduction</label><input id="ngIntroTime" type="time" /></div>
        <div><label class="subtle text-xs">Song for Introduction</label><input id="ngIntroSong" /></div>
        <div><label class="subtle text-xs">First Dance</label><input id="ngFirstDanceSong" /></div>
        <div><label class="subtle text-xs">Parents' Dances</label><input id="ngParentsDances" /></div>
        <div class="md:col-span-2"><label class="subtle text-xs">Special Requests</label><textarea id="ngSpecialRequests"></textarea></div>
        <div><label class="subtle text-xs">Last Song</label><input id="ngLastSong" /></div>
        <div class="md:col-span-2"><label class="subtle text-xs">Do-Not-Play Songs</label><textarea id="ngDoNotPlay"></textarea></div>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="createGigBtn" class="btn">Create</button>
      </div>
    </div>
  </dialog>

  <!-- PDF Preview Modal -->
  <dialog id="pdfModal" class="card modal p-0" style="width:min(900px,95vw);height:min(90vh,900px);">
    <div class="p-4">
      <div class="flex items-center justify-between">
        <div>
          <h3 id="pdfModalTitle" class="text-xl font-bold">Preview</h3>
          <div id="pdfMeta" class="text-xs subtle mt-1"></div>
        </div>
        <div class="flex gap-2">
          <a id="pdfDownloadBtn" class="btn-sec" download>Download</a>
          <button id="closePdfModal" class="btn">Close</button>
        </div>
      </div>
      <div class="mt-3" style="height:75vh;">
        <object id="pdfObject" type="application/pdf" data="" width="100%" height="100%">
          <div class="text-sm subtle p-4">PDF preview not supported in this browser. Use the Download button instead.</div>
        </object>
      </div>
    </div>
  </dialog>

  <!-- YouTube Player Modal -->
  <dialog id="ytModal" class="card modal p-0" style="width:min(960px,95vw);">
    <div class="p-4">
      <div class="flex items-center justify-between">
        <h3 id="ytModalTitle" class="text-xl font-bold">YouTube</h3>
        <div class="flex gap-2">
          <button id="ytShareBtn" class="btn-sec">Share</button>
          <button id="ytCloseBtn" class="btn">Close</button>
        </div>
      </div>
      <div class="mt-3" style="aspect-ratio:16/9;">
        <iframe id="ytIframe" width="100%" height="100%" frameborder="0" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
      </div>
      <div id="ytMeta" class="text-xs subtle mt-2"></div>
      <p id="ytShareHint" class="text-xs subtle mt-2 hidden">Link copied!</p>
    </div>
  </dialog>

  <!-- Passcode Modal -->
  <dialog id="passModal" class="card modal p-0" style="max-width:420px;">
    <div class="p-5">
      <h3 class="text-lg font-bold mb-3">Set/Update Passcodes (optional)</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <input id="userPass" type="password" placeholder="Your passcode (this device)" />
        <input id="adminPass" type="password" placeholder="Admin passcode (Band Off & Admin Login)" />
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="savePassBtn" class="btn">Save</button>
        <button id="closePassBtn" class="btn-sec">Close</button>
      </div>
      <p class="text-xs subtle mt-2">Stored locally; not a cloud login.</p>
    </div>
  </dialog>

  <!-- Admin Login Modal -->
  <dialog id="adminLoginModal" class="card modal p-0" style="max-width:420px;">
    <div class="p-5">
      <h3 class="text-lg font-bold mb-3">Admin Login</h3>
      <input id="adminLoginInput" type="password" placeholder="Admin passcode" />
      <div class="flex justify-end gap-2 mt-4">
        <button id="adminLoginSubmit" class="btn">Login</button>
        <button id="adminLoginClose" class="btn-sec">Cancel</button>
      </div>
      <p class="text-xs subtle mt-2">You‚Äôll stay logged in on this browser until you log out.</p>
    </div>
  </dialog>

  <script>
  /* ===== Helpers ===== */
  function parseLocalDate(s){ const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d); }
  function formatTime12(hhmm){
    if (!hhmm) return '';
    const [h,m]=hhmm.split(':').map(Number);
    const ampm = h>=12?'PM':'AM';
    const h12 = h%12||12;
    return `${h12}:${String(m).padStart(2,'0')} ${ampm}`;
  }

  /* ===== Data (seed) ===== */
  const BAND_MEMBERS = ['greg','john','tim','brian','mark'];
  const MEMBER_NAMES = { greg:'Greg', john:'John', tim:'Tim', brian:'Brian', mark:'Mark' };

  const SEED_EVENTS = [
    { id:1, title:'Sarah & Mike Wedding', date:'2025-11-15', startTime:'18:00', venue:'The Bell Event Centre', address:'312 Elm St, Cincinnati, OH',
      payments:{ greg:{amount:250,paid:true}, john:{amount:200,paid:true}, tim:{amount:200,paid:false}, brian:{amount:225,paid:true}, mark:{amount:200,paid:false} } },
    { id:2, title:'Jazz Night at The Blue Note', date:'2025-11-08', startTime:'20:00', venue:'The Blue Note', address:'456 Main St, Cincinnati, OH',
      payments:{ greg:{amount:180,paid:true}, john:{amount:150,paid:true}, tim:{amount:150,paid:true}, brian:{amount:165,paid:true}, mark:{amount:150,paid:true} } },
    { id:3, title:'Corporate Holiday Party', date:'2025-11-22', startTime:'19:00', venue:'Marriott Downtown', address:'11 W 5th St, Cincinnati, OH',
      payments:{ greg:{amount:300,paid:false}, john:{amount:250,paid:false}, tim:{amount:250,paid:false}, brian:{amount:275,paid:false}, mark:{amount:250,paid:false} } },
    { id:4, title:'Thanksgiving Eve Show', date:'2025-11-26', startTime:'21:00', venue:'The Riverfront Club', address:'789 River Rd, Cincinnati, OH',
      payments:{ greg:{amount:220,paid:false}, john:{amount:180,paid:false}, tim:{amount:180,paid:false}, brian:{amount:195,paid:false}, mark:{amount:180,paid:false} } },
    { id:5, title:'New Years Eve Party', date:'2025-12-31', startTime:'21:00', venue:'Cincinnati Music Hall', address:'1241 Elm St, Cincinnati, OH',
      payments:{ greg:{amount:400,paid:false}, john:{amount:350,paid:false}, tim:{amount:350,paid:false}, brian:{amount:375,paid:false}, mark:{amount:350,paid:false} } }
  ];

  /* ===== Persistence: events in localStorage ===== */
  const EVENTS_KEY = 'ct_events_v1';
  function getEvents(){ try { return JSON.parse(localStorage.getItem(EVENTS_KEY)) || SEED_EVENTS.slice(); } catch { return SEED_EVENTS.slice(); } }
  function setEvents(arr){ localStorage.setItem(EVENTS_KEY, JSON.stringify(arr)); }

  /* ===== Chat (local) ===== */
  const DEMO_CHAT = [
    { name:'Greg', message:'Great show last night everyone!', time:'2:30 PM' },
    { name:'John', message:'Thanks! That crowd was amazing', time:'2:35 PM' },
    { name:'Tim', message:'When is our next rehearsal?', time:'2:40 PM' },
    { name:'Greg', message:'Thursday at 7pm, my place', time:'2:42 PM' },
    { name:'Brian', message:'I\'ll bring the setlist', time:'2:45 PM' },
  ];
  let chatMessages = JSON.parse(localStorage.getItem('ct_chat_v1')||'null') || [...DEMO_CHAT];

  /* ===== Device + Passcodes ===== */
  const DEVICE_KEY = 'ct_device_id_v1';
  let deviceId = localStorage.getItem(DEVICE_KEY);
  if (!deviceId) { deviceId = (crypto.randomUUID && crypto.randomUUID()) || String(Math.random()).slice(2); localStorage.setItem(DEVICE_KEY, deviceId); }

  const PASS_KEYS = { user:'ct_user_pass_v1', admin:'ct_admin_pass_v1', adminSession:'ct_admin_session_v1' };
  async function sha256(text){
    const data = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  async function setPasscodes({user, admin}){
    if (user) localStorage.setItem(PASS_KEYS.user, await sha256(user));
    if (admin) localStorage.setItem(PASS_KEYS.admin, await sha256(admin));
    updateLockStatusUI();
  }
  function adminLoggedIn(){ return localStorage.getItem(PASS_KEYS.adminSession) === '1'; }
  function ensureAdminUI(){
    document.getElementById('addEventBtn').classList.toggle('hidden', !adminLoggedIn());
    document.getElementById('adminLoginBtn').classList.toggle('hidden', adminLoggedIn());
    document.getElementById('adminLogoutBtn').classList.toggle('hidden', !adminLoggedIn());
    clearChatBtn.classList.toggle('hidden', !adminLoggedIn());
  }
  function updateLockStatusUI(){
    const hasUser = !!localStorage.getItem(PASS_KEYS.user);
    const hasAdmin = !!localStorage.getItem(PASS_KEYS.admin);
    document.getElementById('lockStatus').textContent =
      `${hasUser?'Userüîí':'Userüîì'} ‚Ä¢ ${hasAdmin?'Adminüîí':'Adminüîì'} ‚Ä¢ ${adminLoggedIn()?'Logged-in':'Logged-out'}`;
    ensureAdminUI();
  }

  /* ===== Elements ===== */
  const showEventsBtn=document.getElementById('showEventsBtn');
  const toggleChatBtn=document.getElementById('toggleChatBtn');
  const togglePaymentsBtn=document.getElementById('togglePaymentsBtn');
  const toggleChartsBtn=document.getElementById('toggleChartsBtn');
  const toggleYouTubeBtn=document.getElementById('toggleYouTubeBtn');
  const addEventBtn=document.getElementById('addEventBtn');

  const eventsView=document.getElementById('eventsView');
  const chatView=document.getElementById('chatView');
  const paymentsView=document.getElementById('paymentsView');
  const chartsView=document.getElementById('chartsView');
  const youtubeView=document.getElementById('youtubeView');

  const chatMessagesEl=document.getElementById('chatMessages');
  const chatInput=document.getElementById('chatInput');
  const chatName=document.getElementById('chatName');
  const sendChat=document.getElementById('sendChat');
  const clearChatBtn=document.getElementById('clearChatBtn');

  const ytdSummary=document.getElementById('ytdSummary');
  const paymentsList=document.getElementById('paymentsList');

  // Charts repo elements
  const pdfInput=document.getElementById('pdfInput');
  const pdfTitle=document.getElementById('pdfTitle');
  const uploaderName=document.getElementById('uploaderName');
  const uploadPdfBtn=document.getElementById('uploadPdfBtn');
  const searchPdf=document.getElementById('searchPdf');
  const uploaderFilter=document.getElementById('uploaderFilter');
  const clearFiltersBtn=document.getElementById('clearFiltersBtn');
  const exportRepoBtn=document.getElementById('exportRepoBtn');
  const pdfList=document.getElementById('pdfList');
  const emptyRepo=document.getElementById('emptyRepo');

  const pdfModal=document.getElementById('pdfModal');
  const pdfObject=document.getElementById('pdfObject');
  const pdfModalTitle=document.getElementById('pdfModalTitle');
  const pdfMeta=document.getElementById('pdfMeta');
  const pdfDownloadBtn=document.getElementById('pdfDownloadBtn');
  const closePdfModal=document.getElementById('closePdfModal');

  // Event modal
  const gigModal=document.getElementById('gigModal');
  const gigView=document.getElementById('gigView');
  const gigEdit=document.getElementById('gigEdit');
  const shareGigBtn=document.getElementById('shareGigBtn');
  const shareHint=document.getElementById('shareHint');
  const bandOffBtn=document.getElementById('bandOffBtn');
  const clearBandOffBtn=document.getElementById('clearBandOffBtn');
  const editGigBtn=document.getElementById('editGigBtn');
  const deleteGigBtn=document.getElementById('deleteGigBtn');
  const closeGigModal=document.getElementById('closeGigModal');

  const egTitle=document.getElementById('egTitle');
  const egDate=document.getElementById('egDate');
  const egTime=document.getElementById('egTime');
  const egVenue=document.getElementById('egVenue');
  const egAddress=document.getElementById('egAddress');
  const egBandOff=document.getElementById('egBandOff');
  const egCeremonyOnsite = document.getElementById('egCeremonyOnsite');
  const egRoomFlip = document.getElementById('egRoomFlip');
  const egGuestArrivalTime = document.getElementById('egGuestArrivalTime');
  const egBandArrivalTime = document.getElementById('egBandArrivalTime');
  const egIntroTime = document.getElementById('egIntroTime');
  const egIntroSong = document.getElementById('egIntroSong');
  const egFirstDanceSong = document.getElementById('egFirstDanceSong');
  const egParentsDances = document.getElementById('egParentsDances');
  const egSpecialRequests = document.getElementById('egSpecialRequests');
  const egLastSong = document.getElementById('egLastSong');
  const egDoNotPlay = document.getElementById('egDoNotPlay');
  const saveGigBtn=document.getElementById('saveGigBtn');
  const cancelEditBtn=document.getElementById('cancelEditBtn');

  // New event modal
  const newGigModal=document.getElementById('newGigModal');
  const closeNewGigModal=document.getElementById('closeNewGigModal');
  const ngTitle=document.getElementById('ngTitle');
  const ngDate=document.getElementById('ngDate');
  const ngTime=document.getElementById('ngTime');
  const ngVenue=document.getElementById('ngVenue');
  const ngAddress=document.getElementById('ngAddress');
  const ngBandOff=document.getElementById('ngBandOff');
  const ngCeremonyOnsite = document.getElementById('ngCeremonyOnsite');
  const ngRoomFlip = document.getElementById('ngRoomFlip');
  const ngGuestArrivalTime = document.getElementById('ngGuestArrivalTime');
  const ngBandArrivalTime = document.getElementById('ngBandArrivalTime');
  const ngIntroTime = document.getElementById('ngIntroTime');
  const ngIntroSong = document.getElementById('ngIntroSong');
  const ngFirstDanceSong = document.getElementById('ngFirstDanceSong');
  const ngParentsDances = document.getElementById('ngParentsDances');
  const ngSpecialRequests = document.getElementById('ngSpecialRequests');
  const ngLastSong = document.getElementById('ngLastSong');
  const ngDoNotPlay = document.getElementById('ngDoNotPlay');
  const createGigBtn=document.getElementById('createGigBtn');

  // YouTube
  const ytUrl=document.getElementById('ytUrl');
  const ytTitle=document.getElementById('ytTitle');
  const ytNotes=document.getElementById('ytNotes');
  const ytUploader=document.getElementById('ytUploader');
  const addYtBtn=document.getElementById('addYtBtn');
  const ytSearch=document.getElementById('ytSearch');
  const ytUploaderFilter=document.getElementById('ytUploaderFilter');
  const ytClearFilters=document.getElementById('ytClearFilters');
  const ytExportBtn=document.getElementById('ytExportBtn');
  const ytList=document.getElementById('ytList');
  const ytEmpty=document.getElementById('ytEmpty');
  const ytModal=document.getElementById('ytModal');
  const ytModalTitle=document.getElementById('ytModalTitle');
  const ytIframe=document.getElementById('ytIframe');
  const ytMeta=document.getElementById('ytMeta');
  const ytCloseBtn=document.getElementById('ytCloseBtn');
  const ytShareBtn=document.getElementById('ytShareBtn');
  const ytShareHint=document.getElementById('ytShareHint');

  // Pass modal + admin login
  const passModal=document.getElementById('passModal');
  const setPassBtn=document.getElementById('setPassBtn');
  const savePassBtn=document.getElementById('savePassBtn');
  const closePassBtn=document.getElementById('closePassBtn');
  const adminLoginModal=document.getElementById('adminLoginModal');
  const adminLoginBtn=document.getElementById('adminLoginBtn');
  const adminLogoutBtn=document.getElementById('adminLogoutBtn');
  const adminLoginInput=document.getElementById('adminLoginInput');
  const adminLoginSubmit=document.getElementById('adminLoginSubmit');
  const adminLoginClose=document.getElementById('adminLoginClose');

  /* ===== View switching ===== */
  function hideAllViews(){ eventsView.classList.add('hidden'); chatView.classList.add('hidden'); paymentsView.classList.add('hidden'); chartsView.classList.add('hidden'); youtubeView.classList.add('hidden'); }
  function showEventsView(){ hideAllViews(); eventsView.classList.remove('hidden'); renderCalendar(); renderEvents(); }
  function showChatView(){ hideAllViews(); chatView.classList.remove('hidden'); renderChat(); }
  function showPaymentsView(){ hideAllViews(); paymentsView.classList.remove('hidden'); renderPayments(); }
  function showChartsView(){ hideAllViews(); chartsView.classList.remove('hidden'); hydrateUploaderFilter(); renderRepo(); }
  function showYouTubeView(){ hideAllViews(); youtubeView.classList.remove('hidden'); ytHydrateUploaderFilter(); ytRenderRepo(); }

  showEventsBtn.onclick = showEventsView;
  toggleChatBtn.onclick = showChatView;
  togglePaymentsBtn.onclick = showPaymentsView;
  toggleChartsBtn.onclick = showChartsView;
  toggleYouTubeBtn.onclick = showYouTubeView;

  /* ===== Calendar ===== */
  let calendarDate = new Date();

  function renderCalendar(){
    const allEvents = getEvents();
    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth();
    const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']; // Abbreviations
    document.getElementById('calTitle').textContent = `${monthNames[month]} ${year}`;
    const calendar = document.getElementById('monthlyCalendar');
    calendar.innerHTML = '';
    const grid = document.createElement('div'); grid.className='cal-grid';
    dayNames.forEach(d=>{ const h=document.createElement('div'); h.className='cal-header'; h.textContent=d; grid.appendChild(h); });

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month+1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    const today = new Date();
    const isCurrentMonth = today.getFullYear()===year && today.getMonth()===month;
    const todayDate = today.getDate();

    const monthEvents = {};
    allEvents.forEach(ev=>{
      const d = parseLocalDate(ev.date);
      if (d.getFullYear()===year && d.getMonth()===month){
        const day = d.getDate();
        (monthEvents[day] ||= []).push(ev);
      }
    });

    // prev month trailing days
    for (let i=firstDay-1; i>=0; i--){
      const day = daysInPrevMonth - i;
      const cell = document.createElement('div'); cell.className='cal-day other-month';
      cell.innerHTML = `<div class="cal-day-num">${day}</div>`;
      grid.appendChild(cell);
    }

    // this month
    for (let day=1; day<=daysInMonth; day++){
      const cell = document.createElement('div'); cell.className='cal-day';
      const todays = monthEvents[day] || [];
      const hasBandOff = todays.some(ev => ev.bandOff === true);
      const hasAny = todays.length > 0;

      if (hasBandOff) cell.classList.add('band-off');
      else if (hasAny) cell.classList.add('has-event');

      if (isCurrentMonth && day===todayDate) cell.classList.add('today');

      let html = `<div class="cal-day-num">${day}</div>`;
      todays.forEach(ev=> { html += `<div class="cal-event">${ev.startTime?formatTime12(ev.startTime)+' ':''}${ev.bandOff ? 'Band Off' : ev.title}</div>`; });
      cell.innerHTML = html;

      if (todays.length) cell.onclick = ()=> showGigDetail(todays[0].id);
      grid.appendChild(cell);
    }

    // next month leading days
    const total = firstDay + daysInMonth;
    const rem = total % 7 === 0 ? 0 : 7 - (total % 7);
   
