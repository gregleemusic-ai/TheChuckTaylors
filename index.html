<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Chuck Taylors ‚Äî Events</title>
  <meta name="theme-color" content="#ff6b35" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#0d1117; --card:rgba(255,255,255,.06); --card-b:#2b3547; --text:#e5e7eb; --sub:#a3b0c2;
      --brand:#ff6b35; --brand-2:#ffd23f; --danger:#dc2626; --navy:#1e3a8a;
    }
    body{font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--text)}
    .card{background:var(--card);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:14px}
    .btn{background:var(--brand);color:#0d1117;font-weight:700;border-radius:10px;padding:.6rem .9rem;cursor:pointer;border:none}
    .btn:hover{background:#ff865e}
    .btn-sec{background:transparent;border:1px solid var(--brand);color:var(--brand);border-radius:10px;padding:.5rem .8rem;cursor:pointer}
    .btn-sec:hover{background:rgba(255,107,53,.1)}
    .btn-dark{background:#0b1220;border:1px solid var(--card-b);color:var(--text);border-radius:10px;padding:.5rem .8rem;cursor:pointer}
    .btn-dark:hover{background:#141b2b}
    input,select,textarea{background:#0b1220;border:1px solid var(--card-b);border-radius:10px;padding:.55rem .7rem;width:100%;color:var(--text)}
    textarea{min-height:70px}
    label{font-size:.8rem;color:#cbd5e1}
    .subtle{color:var(--sub)}
    .pill{display:inline-block;font-size:.72rem;padding:.2rem .5rem;border:1px solid var(--card-b);border-radius:999px}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:.5rem}
    @media (max-width:640px){.kv{grid-template-columns:1fr}}
    .chat-msg{background:rgba(255,255,255,.05);padding:.75rem;border-radius:8px;border-left:3px solid var(--brand);margin-bottom:.5rem}
    .payment-gig{background:rgba(255,255,255,.03);border:1px solid var(--card-b);border-radius:8px;padding:1rem;margin-bottom:.75rem}
    .payment-status{display:inline-block;padding:.2rem .6rem;border-radius:6px;font-size:.75rem;font-weight:600}
    .payment-status.paid{background:#10b981;color:#fff}
    .payment-status.unpaid{background:#ef4444;color:#fff}

    dialog{border:none;padding:0;max-width:95vw;max-height:90vh;overflow:auto}
    dialog::backdrop{background:rgba(0,0,0,.7)}
    .modal{background:#1a1f2e !important;border:1px solid var(--card-b) !important;color:#fff !important}
    .modal .subtle{color:#cbd5e1}

    /* Modal shell improvements */
    .dialog-inner{display:flex;flex-direction:column;max-height:85vh}
    .dialog-head{position:sticky;top:0;background:#1a1f2e;z-index:1;padding:1rem 1.25rem;border-bottom:1px solid var(--card-b)}
    .dialog-body{overflow:auto;padding:1rem 1.25rem}
    .dialog-actions{position:sticky;bottom:0;background:#1a1f2e;border-top:1px solid var(--card-b);padding:1rem 1.25rem;display:flex;gap:.5rem;flex-wrap:wrap}
    .dialog-actions .btn,.dialog-actions .btn-sec{flex:1 1 140px}

    /* Form grid */
    .form-grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:.75rem}
    .field{grid-column:span 12}
    @media (min-width:768px){.field{grid-column:span 6}}
    .field-full{grid-column:span 12}
    .check{display:flex;align-items:center;gap:.5rem}

    /* Calendar */
    .cal-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:2px;margin-top:.5rem}
    .cal-header{font-size:.8rem;font-weight:700;color:#cbd5e1;text-align:center;padding:.5rem;background:#1a1f2e}
    .cal-day{min-height:86px;background:#fff;color:#0d1117;padding:.5rem;border-radius:4px;position:relative;cursor:pointer;transition:all .2s}
    .cal-day:hover{transform:scale(1.02);box-shadow:0 4px 12px rgba(255,107,53,.3)}
    .cal-day.has-event{background:var(--brand);color:#fff;font-weight:700}
    .cal-day.hold{background:var(--navy) !important;color:#fff !important;font-weight:700}
    .cal-day.band-off{background:var(--danger) !important;color:#fff !important;font-weight:700}
    .cal-day .cal-event{font-size:.72rem;background:rgba(0,0,0,.18);padding:.18rem .3rem;margin-top:.2rem;border-radius:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .cal-day.other-month{opacity:.35}
    .cal-day-num{font-size:1.05rem;font-weight:800;margin-bottom:.25rem}
    .cal-day.today{outline:3px solid var(--brand-2);outline-offset:1px}
    .cal-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}

    /* Repo actions */
    .repo-actions{display:flex;gap:.5rem;flex-wrap:wrap}
    @media (max-width:640px){
      .repo-actions .btn-dark{flex:1 1 calc(33.33% - .5rem);min-width:110px;text-align:center}
    }

    /* Mobile refinements */
    .stack-sm{display:grid;gap:.75rem}
    @media (min-width:1280px){.xl-grid-3{display:grid;grid-template-columns:2fr 1fr;gap:1.25rem}}
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex items-center justify-between mb-6 gap-3">
      <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">The Chuck Taylors ‚Äî Events</h1>
      <div class="flex items-center gap-2 flex-wrap text-sm text-slate-300">
        <button id="setProfileBtn" class="btn-sec">üôã Set My Profile</button>
        <button id="setPassBtn" class="btn-sec">üîí Set Passcode</button>
        <button id="adminLoginBtn" class="btn-sec">üë§ Admin Login</button>
        <button id="adminLogoutBtn" class="btn-sec hidden">‚Ü©Ô∏é Logout</button>
        <span id="profileStatus" class="text-xs subtle"></span>
        <span id="lockStatus" class="text-xs subtle"></span>
      </div>
    </header>

    <!-- Control bar -->
    <div class="card p-3 md:p-4 mb-6">
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <div class="text-sm text-slate-300">Events ‚Ä¢ Chat ‚Ä¢ Payments ‚Ä¢ Charts ‚Ä¢ YouTube</div>
        <div class="flex items-center gap-2 flex-wrap">
          <button id="showeventsBtn" class="btn-sec">üìÖ Dates</button>
          <button id="toggleChatBtn" class="btn-sec">üí¨ Chat</button>
          <button id="togglePaymentsBtn" class="btn-sec">üí∞ Payments</button>
          <button id="toggleChartsBtn" class="btn-sec">üìä Charts</button>
          <button id="toggleYouTubeBtn" class="btn-sec">üé¨ YouTube</button>
          <button id="addGigBtn" class="btn hidden">+ New Event</button>
        </div>
      </div>
    </div>

    <!-- Events View -->
    <div id="eventsView">
      <div class="xl-grid-3">
        <div class="card p-4 min-w-0">
          <div class="cal-nav">
            <button id="prevMonth" class="btn-sec">‚Üê Prev</button>
            <h2 id="calTitle" class="text-2xl font-bold"></h2>
            <button id="nextMonth" class="btn-sec">Next ‚Üí</button>
          </div>
          <div class="flex gap-4 mb-3 text-sm flex-wrap">
            <div class="flex items-center gap-2"><div class="w-4 h-4 bg-white rounded"></div><span>Open Date</span></div>
            <div class="flex items-center gap-2"><div class="w-4 h-4 bg-orange-500 rounded"></div><span>Gig Scheduled</span></div>
            <div class="flex items-center gap-2"><div class="w-4 h-4 bg-red-600 rounded"></div><span>Band Off</span></div>
            <div class="flex items-center gap-2"><div class="w-4 h-4 bg-blue-900 rounded"></div><span>Hold</span></div>
            <div class="flex items-center gap-2"><div class="w-4 h-4 border-4 border-yellow-400 rounded"></div><span>Today</span></div>
          </div>
          <div id="monthlyCalendar"></div>
        </div>

        <div class="card p-4 min-w-0 mt-6 xl:mt-0">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold mb-4">Upcoming Events</h2>
          </div>
          <div id="eventsList" class="space-y-3"></div>
        </div>
      </div>
    </div>

    <!-- Chat -->
    <div id="chatView" class="hidden">
      <div class="card p-6 stack-sm">
        <div class="flex items-center justify-between flex-wrap gap-2">
          <h2 class="text-2xl font-bold">Band Chat</h2>
          <div class="flex gap-2">
            <button id="clearChatBtn" class="btn-sec hidden">üóëÔ∏è Clear Chat (Admin)</button>
          </div>
        </div>
        <div id="chatMessages" class="bg-black bg-opacity-30 rounded-lg p-4 h-96 overflow-y-auto"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <input id="chatName" type="text" placeholder="Your name (optional)" />
          <div class="flex gap-2">
            <input id="chatInput" type="text" placeholder="Type a message..." />
            <button id="sendChat" class="btn">Send</button>
          </div>
        </div>
        <p class="text-xs subtle">Messages are stored only in this browser.</p>
      </div>
    </div>

    <!-- Payments -->
    <div id="paymentsView" class="hidden">
      <div class="card p-6">
        <h2 class="text-2xl font-bold mb-4">Payments ‚Äî YTD 2025</h2>
        <div id="ytdSummary" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6"></div>
        <div id="paymentsList"></div>
      </div>
    </div>

    <!-- Charts / PDFs -->
    <div id="chartsView" class="hidden">
      <div class="card p-6">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h2 class="text-2xl font-bold">Charts & PDFs</h2>
          <span class="pill">Public uploads</span>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="card p-4">
            <h3 class="text-xl font-semibold mb-2">Upload PDFs</h3>
            <p class="text-sm subtle mb-3">Stage plots, setlists, riders, song charts‚Ä¶ (PDF only)</p>
            <input id="pdfInput" type="file" accept="application/pdf" multiple />
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-3">
              <input id="pdfTitle" type="text" placeholder="Optional: title/notes" />
              <input id="uploaderName" type="text" placeholder="Your name (optional)" />
            </div>
            <div class="mt-3"><button id="uploadPdfBtn" class="btn">Upload</button></div>
          </div>

          <div class="card p-4">
            <h3 class="text-xl font-semibold mb-2">Find Files</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
              <input id="searchPdf" type="text" placeholder="Search by filename or notes..." />
              <select id="uploaderFilter"><option value="">All uploaders</option></select>
            </div>
            <div class="mt-3 flex gap-2 flex-wrap">
              <button id="clearFiltersBtn" class="btn-sec">Clear filters</button>
              <button id="exportRepoBtn" class="btn-sec">Export index (.json)</button>
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="text-xl font-bold mb-3">Repository</h3>
          <div id="pdfList" class="grid sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
          <div id="emptyRepo" class="text-slate-400 text-sm hidden">No files yet. Be the first to upload!</div>
        </div>
      </div>
    </div>

    <!-- YouTube -->
    <div id="youtubeView" class="hidden">
      <div class="card p-6">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h2 class="text-2xl font-bold">YouTube Links</h2>
          <span class="pill">Public links</span>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="card p-4">
            <h3 class="text-xl font-semibold mb-2">Add a YouTube Link</h3>
            <p class="text-sm subtle mb-3">Paste a YouTube URL or 11-character video ID.</p>
            <input id="ytUrl" type="text" placeholder="https://www.youtube.com/watch?v=VIDEOID or VIDEOID" />
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-3">
              <input id="ytTitle" type="text" placeholder="Optional title" />
              <input id="ytNotes" type="text" placeholder="Optional notes" />
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-3">
              <input id="ytUploader" type="text" placeholder="Your name (optional)" />
              <button id="addYtBtn" class="btn">Add Link</button>
            </div>
          </div>

          <div class="card p-4">
            <h3 class="text-xl font-semibold mb-2">Find Links</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
              <input id="ytSearch" type="text" placeholder="Search by title or notes..." />
              <select id="ytUploaderFilter"><option value="">All uploaders</option></select>
            </div>
            <div class="mt-3 flex gap-2 flex-wrap">
              <button id="ytClearFilters" class="btn-sec">Clear filters</button>
              <button id="ytExportBtn" class="btn-sec">Export index (.json)</button>
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="text-xl font-bold mb-3">Repository</h3>
          <div id="ytList" class="grid sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
          <div id="ytEmpty" class="text-slate-400 text-sm hidden">No links yet. Add your first!</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Event Detail Modal -->
  <dialog id="gigModal" class="card modal p-0" style="max-width:820px;">
    <div class="dialog-inner">
      <div class="dialog-head">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <h3 class="text-xl font-bold" id="gigTitle"></h3>
          <div class="flex gap-2 flex-wrap">
            <button id="bandOffBtn" class="btn-sec hidden">Mark Band Off</button>
            <button id="clearBandOffBtn" class="btn-sec hidden">Clear Band Off</button>
            <button id="holdBtn" class="btn-sec hidden">Mark Hold</button>
            <button id="clearHoldBtn" class="btn-sec hidden">Clear Hold</button>
            <button id="editGigBtn" class="btn-sec hidden">Edit</button>
            <button id="deleteGigBtn" class="btn-sec hidden">Delete</button>
            <button id="shareGigBtn" class="btn-sec">Share</button>
            <button id="closeGigModal" class="btn">Close</button>
          </div>
        </div>
      </div>

      <div class="dialog-body">
        <!-- View mode -->
        <div id="gigView" class="space-y-2 text-sm"></div>

        <!-- Edit mode -->
        <div id="gigEdit" class="hidden">
          <div class="form-grid">
            <div class="field"><label>Title</label><input id="egTitle" /></div>
            <div class="field"><label>Date</label><input id="egDate" type="date" /></div>
            <div class="field"><label>Start Time</label><input id="egTime" type="time" /></div>
            <div class="field"><label>Venue</label><input id="egVenue" /></div>
            <div class="field-full"><label>Address</label><input id="egAddress" /></div>

            <div class="field check"><input id="egBandOff" type="checkbox" /><label>Band Off</label></div>
            <div class="field check"><input id="egHold" type="checkbox" /><label>Hold</label></div>

            <div class="field check"><input id="egCeremonyOnsite" type="checkbox" /><label>Ceremony onsite?</label></div>
            <div class="field check"><input id="egRoomFlip" type="checkbox" /><label>Room flip?</label></div>

            <div class="field"><label>Guest Arrival</label><input id="egGuestArrivalTime" type="time" /></div>
            <div id="egCeremonyGuestArrivalRow" class="field hidden">
              <label>Guest Arrival (Ceremony)</label>
              <input id="egCeremonyGuestArrivalTime" type="time" />
            </div>

            <div class="field"><label>Band Arrival</label><input id="egBandArrivalTime" type="time" /></div>
            <div class="field"><label>Time of Introduction</label><input id="egIntroTime" type="time" /></div>
            <div class="field-full"><label>Song for Introduction</label><input id="egIntroSong" /></div>

            <!-- Cocktails -->
            <div class="field-full"><label>Cocktails</label><input id="egCocktails" placeholder="e.g., 5:30‚Äì6:30pm in foyer" /></div>
            <div class="field check"><input id="egCocktailsSeparate" type="checkbox" /><label>Separate location?</label></div>
            <div class="field check"><input id="egCocktailsBandPlay" type="checkbox" /><label>Band playing cocktails?</label></div>

            <!-- Dances -->
            <div class="field"><label>First Dance (song)</label><input id="egFirstDanceSong" /></div>
            <div class="field check"><input id="egFirstDancePlay" type="checkbox" /><label>Band to play First Dance</label></div>

            <div class="field"><label>Father / Daughter (song)</label><input id="egFatherDaughterSong" /></div>
            <div class="field check"><input id="egFatherDaughterPlay" type="checkbox" /><label>Band to play F/D</label></div>

            <div class="field"><label>Mother / Son (song)</label><input id="egMotherSonSong" /></div>
            <div class="field check"><input id="egMotherSonPlay" type="checkbox" /><label>Band to play M/S</label></div>

            <div class="field-full"><label>Meals</label><textarea id="egMeals" placeholder="e.g., 5 vendor meals; 1 vegetarian; served 6:30pm"></textarea></div>
            <div class="field"><label>Last Song</label><input id="egLastSong" /></div>
            <div class="field-full"><label>Special Requests</label><textarea id="egSpecialRequests"></textarea></div>
            <div class="field-full"><label>Do-Not-Play Songs</label><textarea id="egDoNotPlay"></textarea></div>
          </div>
        </div>
        <p id="shareHint" class="text-xs subtle mt-3 hidden">Link copied!</p>
      </div>

      <div class="dialog-actions">
        <button id="saveGigBtn" class="btn hidden">Save</button>
        <button id="cancelEditBtn" class="btn-sec hidden">Cancel</button>
      </div>
    </div>
  </dialog>

  <!-- New Event Modal -->
  <dialog id="newGigModal" class="card modal p-0" style="max-width:820px;">
    <div class="dialog-inner">
      <div class="dialog-head">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold">New Event</h3>
          <button id="closeNewGigModal" class="btn-sec">Close</button>
        </div>
      </div>
      <div class="dialog-body">
        <div class="form-grid">
          <div class="field"><label>Title</label><input id="ngTitle" /></div>
          <div class="field"><label>Date</label><input id="ngDate" type="date" /></div>
          <div class="field"><label>Start Time</label><input id="ngTime" type="time" /></div>
          <div class="field"><label>Venue</label><input id="ngVenue" /></div>
          <div class="field-full"><label>Address</label><input id="ngAddress" /></div>

          <div class="field check"><input id="ngBandOff" type="checkbox" /><label>Band Off</label></div>
          <div class="field check"><input id="ngHold" type="checkbox" /><label>Hold</label></div>

          <div class="field check"><input id="ngCeremonyOnsite" type="checkbox" /><label>Ceremony onsite?</label></div>
          <div class="field check"><input id="ngRoomFlip" type="checkbox" /><label>Room flip?</label></div>

          <div class="field"><label>Guest Arrival</label><input id="ngGuestArrivalTime" type="time" /></div>
          <div id="ngCeremonyGuestArrivalRow" class="field hidden">
            <label>Guest Arrival (Ceremony)</label>
            <input id="ngCeremonyGuestArrivalTime" type="time" />
          </div>

          <div class="field"><label>Band Arrival</label><input id="ngBandArrivalTime" type="time" /></div>
          <div class="field"><label>Time of Introduction</label><input id="ngIntroTime" type="time" /></div>
          <div class="field-full"><label>Song for Introduction</label><input id="ngIntroSong" /></div>

          <!-- Cocktails -->
          <div class="field-full"><label>Cocktails</label><input id="ngCocktails" placeholder="e.g., 5:30‚Äì6:30pm in foyer" /></div>
          <div class="field check"><input id="ngCocktailsSeparate" type="checkbox" /><label>Separate location?</label></div>
          <div class="field check"><input id="ngCocktailsBandPlay" type="checkbox" /><label>Band playing cocktails?</label></div>

          <!-- Dances -->
          <div class="field"><label>First Dance (song)</label><input id="ngFirstDanceSong" /></div>
          <div class="field check"><input id="ngFirstDancePlay" type="checkbox" /><label>Band to play First Dance</label></div>

          <div class="field"><label>Father / Daughter (song)</label><input id="ngFatherDaughterSong" /></div>
          <div class="field check"><input id="ngFatherDaughterPlay" type="checkbox" /><label>Band to play F/D</label></div>

          <div class="field"><label>Mother / Son (song)</label><input id="ngMotherSonSong" /></div>
          <div class="field check"><input id="ngMotherSonPlay" type="checkbox" /><label>Band to play M/S</label></div>

          <div class="field-full"><label>Meals</label><textarea id="ngMeals" placeholder="e.g., 5 vendor meals; 1 vegetarian; served 6:30pm"></textarea></div>
          <div class="field"><label>Last Song</label><input id="ngLastSong" /></div>
          <div class="field-full"><label>Special Requests</label><textarea id="ngSpecialRequests"></textarea></div>
          <div class="field-full"><label>Do-Not-Play Songs</label><textarea id="ngDoNotPlay"></textarea></div>
        </div>
      </div>
      <div class="dialog-actions">
        <button id="createGigBtn" class="btn">Create</button>
      </div>
    </div>
  </dialog>

  <!-- PDF Preview Modal -->
  <dialog id="pdfModal" class="card modal p-0" style="width:min(900px,95vw);height:min(90vh,900px);">
    <div class="p-4">
      <div class="flex items-center justify-between">
        <div>
          <h3 id="pdfModalTitle" class="text-xl font-bold">Preview</h3>
          <div id="pdfMeta" class="text-xs subtle mt-1"></div>
        </div>
        <div class="flex gap-2">
          <a id="pdfDownloadBtn" class="btn-sec" download>Download</a>
          <button id="closePdfModal" class="btn">Close</button>
        </div>
      </div>
      <div class="mt-3" style="height:75vh;">
        <object id="pdfObject" type="application/pdf" data="" width="100%" height="100%">
          <div class="text-sm subtle p-4">PDF preview not supported in this browser. Use the Download button instead.</div>
        </object>
      </div>
    </div>
  </dialog>

  <!-- YouTube Player Modal -->
  <dialog id="ytModal" class="card modal p-0" style="width:min(960px,95vw);">
    <div class="p-4">
      <div class="flex items-center justify-between">
        <h3 id="ytModalTitle" class="text-xl font-bold">YouTube</h3>
        <div class="flex gap-2">
          <button id="ytShareBtn" class="btn-sec">Share</button>
          <button id="ytCloseBtn" class="btn">Close</button>
        </div>
      </div>
      <div class="mt-3" style="aspect-ratio:16/9;">
        <iframe id="ytIframe" width="100%" height="100%" frameborder="0" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
      </div>
      <div id="ytMeta" class="text-xs subtle mt-2"></div>
      <p id="ytShareHint" class="text-xs subtle mt-2 hidden">Link copied!</p>
    </div>
  </dialog>

  <!-- Passcode Modal -->
  <dialog id="passModal" class="card modal p-0" style="max-width:420px;">
    <div class="p-5">
      <h3 class="text-lg font-bold mb-3">Set/Update Passcodes (optional)</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <input id="userPass" type="password" placeholder="Your passcode (this device)" />
        <input id="adminPass" type="password" placeholder="Admin passcode (Admin & Band Off/Hold)" />
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="savePassBtn" class="btn">Save</button>
        <button id="closePassBtn" class="btn-sec">Close</button>
      </div>
      <p class="text-xs subtle mt-2">Stored locally; not a cloud login.</p>
    </div>
  </dialog>

  <!-- Admin Login Modal -->
  <dialog id="adminLoginModal" class="card modal p-0" style="max-width:420px;">
    <div class="p-5">
      <h3 class="text-lg font-bold mb-3">Admin Login</h3>
      <input id="adminLoginInput" type="password" placeholder="Admin passcode" />
      <div class="flex justify-end gap-2 mt-4">
        <button id="adminLoginSubmit" class="btn">Login</button>
        <button id="adminLoginClose" class="btn-sec">Cancel</button>
      </div>
      <p class="text-xs subtle mt-2">You'll stay logged in on this browser until you log out.</p>
    </div>
  </dialog>

  <!-- Profile Modal -->
  <dialog id="profileModal" class="card modal p-0" style="max-width:420px;">
    <div class="p-5">
      <h3 class="text-lg font-bold mb-3">Choose Your Profile</h3>
      <label class="subtle text-xs mb-1 block">This device belongs to</label>
      <select id="profileSelect" class="w-full">
        <option value="">‚Äî Select band member ‚Äî</option>
        <option value="greg">Greg</option>
        <option value="john">John</option>
        <option value="tim">Tim</option>
        <option value="brian">Brian</option>
        <option value="mark">Mark</option>
      </select>
      <div class="flex justify-end gap-2 mt-4">
        <button id="saveProfileBtn" class="btn">Save</button>
        <button id="closeProfileBtn" class="btn-sec">Cancel</button>
      </div>
      <p class="text-xs subtle mt-2">Saved to this browser only.</p>
    </div>
  </dialog>

  <script>
    /* ===== Seed Data ===== */
    const BAND_MEMBERS = ['greg','john','tim','brian','mark'];
    const MEMBER_NAMES = { greg:'Greg', john:'John', tim:'Tim', brian:'Brian', mark:'Mark' };

    // Empty seed data - start fresh
    const SEED_events = [];

    /* ===== Persistence ===== */
    const events_KEY = 'ct_events_v3';
    function getevents(){ try { return JSON.parse(localStorage.getItem(events_KEY)) || SEED_events.slice(); } catch { return SEED_events.slice(); } }
    function setevents(arr){ localStorage.setItem(events_KEY, JSON.stringify(arr)); }

    /* ===== Chat (local) ===== */
    const DEMO_CHAT = [];
    let chatMessages = JSON.parse(localStorage.getItem('ct_chat_v1')||'null') || [...DEMO_CHAT];

    /* ===== Device + Passcodes ===== */
    const DEVICE_KEY = 'ct_device_id_v1';
    let deviceId = localStorage.getItem(DEVICE_KEY);
    if (!deviceId) { deviceId = (crypto.randomUUID && crypto.randomUUID()) || String(Math.random()).slice(2); localStorage.setItem(DEVICE_KEY, deviceId); }

    const PASS_KEYS = { user:'ct_user_pass_v1', admin:'ct_admin_pass_v1', adminSession:'ct_admin_session_v1' };
    async function sha256(text){
      const data = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    async function setPasscodes({user, admin}){
      if (user) localStorage.setItem(PASS_KEYS.user, await sha256(user));
      if (admin) localStorage.setItem(PASS_KEYS.admin, await sha256(admin));
      updateLockStatusUI();
    }
    function adminLoggedIn(){ return localStorage.getItem(PASS_KEYS.adminSession) === '1'; }
    function ensureAdminUI(){
      document.getElementById('addGigBtn').classList.toggle('hidden', !adminLoggedIn());
      document.getElementById('adminLoginBtn').classList.toggle('hidden', adminLoggedIn());
      document.getElementById('adminLogoutBtn').classList.toggle('hidden', !adminLoggedIn());
      document.getElementById('clearChatBtn').classList.toggle('hidden', !adminLoggedIn());
      // Edit/save controls in modal get toggled when opening
    }
    function updateLockStatusUI(){
      const hasUser = !!localStorage.getItem(PASS_KEYS.user);
      const hasAdmin = !!localStorage.getItem(PASS_KEYS.admin);
      document.getElementById('lockStatus').textContent =
        `${hasUser?'Userüîí':'Userüîì'} ‚Ä¢ ${hasAdmin?'Adminüîí':'Adminüîì'} ‚Ä¢ ${adminLoggedIn()?'Logged-in':'Logged-out'}`;
      ensureAdminUI();
    }

    /* ===== Member profile (device identity) ===== */
    const MEMBER_KEY = 'ct_member_v1';
    function getCurrentMember(){ return localStorage.getItem(MEMBER_KEY) || ''; }
    function setCurrentMember(m){ m ? localStorage.setItem(MEMBER_KEY, m) : localStorage.removeItem(MEMBER_KEY); updateProfileStatus(); }
    function updateProfileStatus(){
      const me = getCurrentMember();
      const el = document.getElementById('profileStatus');
      el.textContent = me ? `‚Ä¢ Profile: ${MEMBER_NAMES[me]}` : '‚Ä¢ No profile set';
    }

    /* ===== Elements ===== */
    const showeventsBtn=document.getElementById('showeventsBtn');
    const toggleChatBtn=document.getElementById('toggleChatBtn');
    const togglePaymentsBtn=document.getElementById('togglePaymentsBtn');
    const toggleChartsBtn=document.getElementById('toggleChartsBtn');
    const toggleYouTubeBtn=document.getElementById('toggleYouTubeBtn');
    const addGigBtn=document.getElementById('addGigBtn');

    const eventsView=document.getElementById('eventsView');
    const chatView=document.getElementById('chatView');
    const paymentsView=document.getElementById('paymentsView');
    const chartsView=document.getElementById('chartsView');
    const youtubeView=document.getElementById('youtubeView');

    const chatMessagesEl=document.getElementById('chatMessages');
    const chatInput=document.getElementById('chatInput');
    const chatName=document.getElementById('chatName');
    const sendChat=document.getElementById('sendChat');
    const clearChatBtn=document.getElementById('clearChatBtn');

    const ytdSummary=document.getElementById('ytdSummary');
    const paymentsList=document.getElementById('paymentsList');

    // Charts repo elements
    const pdfInput=document.getElementById('pdfInput');
    const pdfTitle=document.getElementById('pdfTitle');
    const uploaderName=document.getElementById('uploaderName');
    const uploadPdfBtn=document.getElementById('uploadPdfBtn');
    const searchPdf=document.getElementById('searchPdf');
    const uploaderFilter=document.getElementById('uploaderFilter');
    const clearFiltersBtn=document.getElementById('clearFiltersBtn');
    const exportRepoBtn=document.getElementById('exportRepoBtn');
    const pdfList=document.getElementById('pdfList');
    const emptyRepo=document.getElementById('emptyRepo');

    const pdfModal=document.getElementById('pdfModal');
    const pdfObject=document.getElementById('pdfObject');
    const pdfModalTitle=document.getElementById('pdfModalTitle');
    const pdfMeta=document.getElementById('pdfMeta');
    const pdfDownloadBtn=document.getElementById('pdfDownloadBtn');
    const closePdfModal=document.getElementById('closePdfModal');

    // Event modal
    const gigModal=document.getElementById('gigModal');
    const gigTitleEl=document.getElementById('gigTitle');
    const gigView=document.getElementById('gigView');
    const gigEdit=document.getElementById('gigEdit');
    const shareGigBtn=document.getElementById('shareGigBtn');
    const shareHint=document.getElementById('shareHint');
    const bandOffBtn=document.getElementById('bandOffBtn');
    const clearBandOffBtn=document.getElementById('clearBandOffBtn');
    const holdBtn=document.getElementById('holdBtn');
    const clearHoldBtn=document.getElementById('clearHoldBtn');
    const editGigBtn=document.getElementById('editGigBtn');
    const deleteGigBtn=document.getElementById('deleteGigBtn');
    const closeGigModal=document.getElementById('closeGigModal');

    const egTitle=document.getElementById('egTitle');
    const egDate=document.getElementById('egDate');
    const egTime=document.getElementById('egTime');
    const egVenue=document.getElementById('egVenue');
    const egAddress=document.getElementById('egAddress');
    const egBandOff=document.getElementById('egBandOff');
    const egHold=document.getElementById('egHold');

    const egCeremonyOnsite=document.getElementById('egCeremonyOnsite');
    const egRoomFlip=document.getElementById('egRoomFlip');
    const egGuestArrivalTime=document.getElementById('egGuestArrivalTime');
    const egCeremonyGuestArrivalRow=document.getElementById('egCeremonyGuestArrivalRow');
    const egCeremonyGuestArrivalTime=document.getElementById('egCeremonyGuestArrivalTime');
    const egBandArrivalTime=document.getElementById('egBandArrivalTime');
    const egIntroTime=document.getElementById('egIntroTime');
    const egIntroSong=document.getElementById('egIntroSong');

    const egCocktails=document.getElementById('egCocktails');
    const egCocktailsSeparate=document.getElementById('egCocktailsSeparate');
    const egCocktailsBandPlay=document.getElementById('egCocktailsBandPlay');

    const egFirstDanceSong=document.getElementById('egFirstDanceSong');
    const egFirstDancePlay=document.getElementById('egFirstDancePlay');

    const egFatherDaughterSong=document.getElementById('egFatherDaughterSong');
    const egFatherDaughterPlay=document.getElementById('egFatherDaughterPlay');

    const egMotherSonSong=document.getElementById('egMotherSonSong');
    const egMotherSonPlay=document.getElementById('egMotherSonPlay');

    const egMeals=document.getElementById('egMeals');
    const egLastSong=document.getElementById('egLastSong');
    const egSpecialRequests=document.getElementById('egSpecialRequests');
    const egDoNotPlay=document.getElementById('egDoNotPlay');

    const saveGigBtn=document.getElementById('saveGigBtn');
    const cancelEditBtn=document.getElementById('cancelEditBtn');

    // New event modal
    const newGigModal=document.getElementById('newGigModal');
    const closeNewGigModal=document.getElementById('closeNewGigModal');
    const ngTitle=document.getElementById('ngTitle');
    const ngDate=document.getElementById('ngDate');
    const ngTime=document.getElementById('ngTime');
    const ngVenue=document.getElementById('ngVenue');
    const ngAddress=document.getElementById('ngAddress');
    const ngBandOff=document.getElementById('ngBandOff');
    const ngHold=document.getElementById('ngHold');

    const ngCeremonyOnsite=document.getElementById('ngCeremonyOnsite');
    const ngRoomFlip=document.getElementById('ngRoomFlip');
    const ngGuestArrivalTime=document.getElementById('ngGuestArrivalTime');
    const ngCeremonyGuestArrivalRow=document.getElementById('ngCeremonyGuestArrivalRow');
    const ngCeremonyGuestArrivalTime=document.getElementById('ngCeremonyGuestArrivalTime');
    const ngBandArrivalTime=document.getElementById('ngBandArrivalTime');
    const ngIntroTime=document.getElementById('ngIntroTime');
    const ngIntroSong=document.getElementById('ngIntroSong');

    const ngCocktails=document.getElementById('ngCocktails');
    const ngCocktailsSeparate=document.getElementById('ngCocktailsSeparate');
    const ngCocktailsBandPlay=document.getElementById('ngCocktailsBandPlay');

    const ngFirstDanceSong=document.getElementById('ngFirstDanceSong');
    const ngFirstDancePlay=document.getElementById('ngFirstDancePlay');

    const ngFatherDaughterSong=document.getElementById('ngFatherDaughterSong');
    const ngFatherDaughterPlay=document.getElementById('ngFatherDaughterPlay');

    const ngMotherSonSong=document.getElementById('ngMotherSonSong');
    const ngMotherSonPlay=document.getElementById('ngMotherSonPlay');

    const ngMeals=document.getElementById('ngMeals');
    const ngLastSong=document.getElementById('ngLastSong');
    const ngSpecialRequests=document.getElementById('ngSpecialRequests');
    const ngDoNotPlay=document.getElementById('ngDoNotPlay');

    const createGigBtn=document.getElementById('createGigBtn');

    // YouTube
    const ytUrl=document.getElementById('ytUrl');
    const ytTitle=document.getElementById('ytTitle');
    const ytNotes=document.getElementById('ytNotes');
    const ytUploader=document.getElementById('ytUploader');
    const addYtBtn=document.getElementById('addYtBtn');
    const ytSearch=document.getElementById('ytSearch');
    const ytUploaderFilter=document.getElementById('ytUploaderFilter');
    const ytClearFilters=document.getElementById('ytClearFilters');
    const ytExportBtn=document.getElementById('ytExportBtn');
    const ytList=document.getElementById('ytList');
    const ytEmpty=document.getElementById('ytEmpty');
    const ytModal=document.getElementById('ytModal');
    const ytModalTitle=document.getElementById('ytModalTitle');
    const ytIframe=document.getElementById('ytIframe');
    const ytMeta=document.getElementById('ytMeta');
    const ytCloseBtn=document.getElementById('ytCloseBtn');
    const ytShareBtn=document.getElementById('ytShareBtn');
    const ytShareHint=document.getElementById('ytShareHint');

    // Pass + Admin
    const passModal=document.getElementById('passModal');
    const setPassBtn=document.getElementById('setPassBtn');
    const savePassBtn=document.getElementById('savePassBtn');
    const closePassBtn=document.getElementById('closePassBtn');
    const adminLoginModal=document.getElementById('adminLoginModal');
    const adminLoginBtn=document.getElementById('adminLoginBtn');
    const adminLogoutBtn=document.getElementById('adminLogoutBtn');
    const adminLoginInput=document.getElementById('adminLoginInput');
    const adminLoginSubmit=document.getElementById('adminLoginSubmit');
    const adminLoginClose=document.getElementById('adminLoginClose');

    // Profile modal
    const setProfileBtn = document.getElementById('setProfileBtn');
    const profileModal = document.getElementById('profileModal');
    const profileSelect = document.getElementById('profileSelect');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const closeProfileBtn = document.getElementById('closeProfileBtn');

    // Calendar navigation
    const prevMonth = document.getElementById('prevMonth');
    const nextMonth = document.getElementById('nextMonth');

    /* ===== View switching ===== */
    function hideAllViews(){ eventsView.classList.add('hidden'); chatView.classList.add('hidden'); paymentsView.classList.add('hidden'); chartsView.classList.add('hidden'); youtubeView.classList.add('hidden'); }
    function showeventsView(){ hideAllViews(); eventsView.classList.remove('hidden'); renderCalendar(); renderevents(); }
    function showChatView(){ hideAllViews(); chatView.classList.remove('hidden'); renderChat(); }
    function showPaymentsView(){ hideAllViews(); paymentsView.classList.remove('hidden'); renderPayments(); }
    function showChartsView(){ hideAllViews(); chartsView.classList.remove('hidden'); hydrateUploaderFilter(); renderRepo(); }
    function showYouTubeView(){ hideAllViews(); youtubeView.classList.remove('hidden'); ytHydrateUploaderFilter(); ytRenderRepo(); }

    showeventsBtn.onclick = showeventsView;
    toggleChatBtn.onclick = showChatView;
    togglePaymentsBtn.onclick = showPaymentsView;
    toggleChartsBtn.onclick = showChartsView;
    toggleYouTubeBtn.onclick = showYouTubeView;

    /* ===== Dates/Time helpers ===== */
    function parseYMD(yyyy_mm_dd){
      // Local (no timezone drift)
      const [y,m,d] = (yyyy_mm_dd||'').split('-').map(Number);
      return new Date(y, (m||1)-1, d||1, 0,0,0,0);
    }
    function formatTime12(hhmm){
      if(!hhmm) return '';
      const [hStr,mStr] = hhmm.split(':');
      let h = parseInt(hStr,10); const m = parseInt(mStr||'0',10);
      const ampm = h>=12?'PM':'AM';
      h = h%12; if (h===0) h=12;
      return `${h}:${String(m).padStart(2,'0')} ${ampm}`;
    }

    /* ===== Calendar ===== */
    let calendarDate = new Date();
    
    prevMonth.onclick = () => {
      calendarDate.setMonth(calendarDate.getMonth() - 1);
      renderCalendar();
    };
    
    nextMonth.onclick = () => {
      calendarDate.setMonth(calendarDate.getMonth() + 1);
      renderCalendar();
    };
    
    function renderCalendar(){
      const events = getevents();
      const year = calendarDate.getFullYear();
      const month = calendarDate.getMonth();

      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      const dayAbbr = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      document.getElementById('calTitle').textContent = `${monthNames[month]} ${year}`;

      const calendar = document.getElementById('monthlyCalendar');
      calendar.innerHTML = '';
      const grid = document.createElement('div'); grid.className='cal-grid';
      dayAbbr.forEach(d=>{ const h=document.createElement('div'); h.className='cal-header'; h.textContent=d; grid.appendChild(h); });

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();
      const daysInPrevMonth = new Date(year, month, 0).getDate();
      const today = new Date();
      const isCurrentMonth = today.getFullYear()===year && today.getMonth()===month;
      const todayDate = today.getDate();

      const monthEvents = {};
      events.forEach(g=>{
        const d = parseYMD(g.date);
        if (d.getFullYear()===year && d.getMonth()===month){
          const day = d.getDate();
          (monthEvents[day] ||= []).push(g);
        }
      });

      for (let i=firstDay-1; i>=0; i--){
        const day = daysInPrevMonth - i;
        const cell = document.createElement('div'); cell.className='cal-day other-month';
        cell.innerHTML = `<div class="cal-day-num">${day}</div>`;
        grid.appendChild(cell);
      }
      for (let day=1; day<=daysInMonth; day++){
        const cell = document.createElement('div'); cell.className='cal-day';
        const eventsToday = monthEvents[day] || [];
        const hasHold = eventsToday.some(g => g.hold === true);
        const hasBandOff = eventsToday.some(g => g.bandOff === true);
        const hasAnyGig  = eventsToday.length > 0;

        if (hasHold) cell.classList.add('hold');
        else if (hasBandOff) cell.classList.add('band-off');
        else if (hasAnyGig) cell.classList.add('has-event');

        if (isCurrentMonth && day===todayDate) cell.classList.add('today');

        let html = `<div class="cal-day-num">${day}</div>`;
        eventsToday.forEach(g=> {
          const label = g.bandOff ? 'Band Off' : (g.hold ? 'Hold' : g.title);
          html += `<div class="cal-event">${g.startTime ? formatTime12(g.startTime)+' ‚Ä¢ ' : ''}${label}</div>`;
        });
        cell.innerHTML = html;

        if (eventsToday.length) cell.onclick = ()=> showGigDetail(eventsToday[0].id);
        grid.appendChild(cell);
      }
      const total = firstDay + daysInMonth;
      const rem = total % 7 === 0 ? 0 : 7 - (total % 7);
      for (let day=1; day<=rem; day++){
        const cell = document.createElement('div'); cell.className='cal-day other-month';
        cell.innerHTML = `<div class="cal-day-num">${day}</div>`;
        grid.appendChild(cell);
      }
      calendar.appendChild(grid);
    }

    /* ===== Events list ===== */
    function renderevents(){
      const events = getevents().slice().sort((a,b)=> parseYMD(a.date) - parseYMD(b.date));
      const eventsList = document.getElementById('eventsList');
      eventsList.innerHTML = '';
      
      if (events.length === 0) {
        eventsList.innerHTML = '<div class="text-slate-400 text-sm">No events yet. Add your first event!</div>';
        return;
      }
      
      events.forEach(g=>{
        const div = document.createElement('div');
        const cat = g.hold ? `<span class="pill" style="border-color:#1e3a8a;color:#fff;background:#1e3a8a">Hold</span>` :
                    g.bandOff ? `<span class="pill" style="border-color:#dc2626;color:#fff;background:#dc2626">Band Off</span>` : '';
        div.className='p-3 card cursor-pointer hover:bg-white hover:bg-opacity-10 transition-all';
        div.innerHTML = `
          <div>
            <div class="text-sm subtle">${g.date}${g.startTime?' ‚Ä¢ '+formatTime12(g.startTime):''}</div>
            <div class="font-semibold">${g.title} ${cat}</div>
            <div class="text-xs text-slate-400">${g.venue||''}</div>
            <button class="btn-sec mt-2 text-xs" onclick="showGigDetail(${g.id})">View Details</button>
          </div>`;
        eventsList.appendChild(div);
      });
    }

    /* ===== Event modal (view/edit/delete) ===== */
    let currentGigId = null;

    window.showGigDetail = function(id, pushHash = true){
      const events = getevents();
      const g = events.find(x=> x.id===id); if(!g) return;
      currentGigId = id;

      document.getElementById('gigTitle').textContent = g.title;
      const badge = g.bandOff
        ? `<div class="mb-3 text-sm" style="background:#dc2626;color:#fff;padding:.4rem .6rem;border-radius:8px;display:inline-block">Band Off</div>`
        : g.hold
        ? `<div class="mb-3 text-sm" style="background:#1e3a8a;color:#fff;padding:.4rem .6rem;border-radius:8px;display:inline-block">Hold</div>`
        : '';

      // Optional rows
      const mealsRow = g.meals ? `<div class="kv"><div class="subtle">Meals</div><div>${g.meals}</div></div>` : '';

      const cocktailsRows = `
        ${g.cocktails ? `<div class="kv"><div class="subtle">Cocktails</div><div>${g.cocktails}</div></div>` : ''}
        ${g.cocktailsSeparate ? `<div class="kv"><div class="subtle">Separate Location</div><div>Yes</div></div>` : ''}
        ${g.cocktailsBandPlay ? `<div class="kv"><div class="subtle">Band Playing Cocktails</div><div>Yes</div></div>` : ''}
      `;

      const ceremonyArrivalRow = (g.ceremonyOnsite && g.ceremonyGuestArrivalTime)
        ? `<div class="kv"><div class="subtle">Guest Arrival (Ceremony)</div><div>${formatTime12(g.ceremonyGuestArrivalTime)}</div></div>` : '';

      const firstDanceRow = g.firstDanceSong || g.firstDancePlay
        ? `<div class="kv"><div class="subtle">First Dance</div><div>${g.firstDanceSong||''}${g.firstDancePlay?' ‚Ä¢ Band to play':''}</div></div>` : '';

      const fdRow = g.fatherDaughterSong || g.fatherDaughterPlay
        ? `<div class="kv"><div class="subtle">Father / Daughter</div><div>${g.fatherDaughterSong||''}${g.fatherDaughterPlay?' ‚Ä¢ Band to play':''}</div></div>` : '';

      const msRow = g.motherSonSong || g.motherSonPlay
        ? `<div class="kv"><div class="subtle">Mother / Son</div><div>${g.motherSonSong||''}${g.motherSonPlay?' ‚Ä¢ Band to play':''}</div></div>` : '';

      const specialRow = g.specialRequests ? `<div class="kv"><div class="subtle">Special Requests</div><div>${g.specialRequests}</div></div>` : '';
      const dnpRow = g.doNotPlay ? `<div class="kv"><div class="subtle">Do-Not-Play</div><div>${g.doNotPlay}</div></div>` : '';
      const lastSongRow = g.lastSong ? `<div class="kv"><div class="subtle">Last Song</div><div>${g.lastSong}</div></div>` : '';

      gigView.innerHTML = `
        ${badge}
        <div class="kv"><div class="subtle">Date</div><div>${g.date}${g.startTime?' at '+formatTime12(g.startTime):''}</div></div>
        <div class="kv"><div class="subtle">Venue</div><div>${g.venue||''}</div></div>
        <div class="kv"><div class="subtle">Address</div><div>${g.address||''}</div></div>

        <div class="kv"><div class="subtle">Ceremony Onsite</div><div>${g.ceremonyOnsite?'Yes':'No'}</div></div>
        <div class="kv"><div class="subtle">Room Flip</div><div>${g.roomFlip?'Yes':'No'}</div></div>
        ${g.guestArrivalTime ? `<div class="kv"><div class="subtle">Guest Arrival</div><div>${formatTime12(g.guestArrivalTime)}</div></div>`:''}
        ${ceremonyArrivalRow}
        ${g.bandArrivalTime ? `<div class="kv"><div class="subtle">Band Arrival</div><div>${formatTime12(g.bandArrivalTime)}</div></div>`:''}
        ${g.introTime ? `<div class="kv"><div class="subtle">Time of Introduction</div><div>${formatTime12(g.introTime)}</div></div>`:''}
        ${g.introSong ? `<div class="kv"><div class="subtle">Song for Introduction</div><div>${g.introSong}</div></div>`:''}

        ${cocktailsRows}
        ${firstDanceRow}
        ${fdRow}
        ${msRow}
        ${mealsRow}
        ${lastSongRow}
        ${specialRow}
        ${dnpRow}
      `;

      // Admin-only controls visible on session
      const isAdmin = adminLoggedIn();
      editGigBtn.classList.toggle('hidden', !isAdmin);
      deleteGigBtn.classList.toggle('hidden', !isAdmin);
      bandOffBtn.classList.toggle('hidden', !isAdmin || g.bandOff === true);
      clearBandOffBtn.classList.toggle('hidden', !isAdmin || g.bandOff !== true);
      holdBtn.classList.toggle('hidden', !isAdmin || g.hold === true);
      clearHoldBtn.classList.toggle('hidden', !isAdmin || g.hold !== true);

      // wire share
      shareGigBtn.onclick = ()=> shareGig(id);

      // wire Band Off / Hold toggles
      bandOffBtn.onclick = ()=> { const ev=getevents(); const i=ev.findIndex(x=>x.id===id); if(i>=0){ ev[i].bandOff=true; setevents(ev); renderCalendar(); renderevents(); showGigDetail(id,false);} };
      clearBandOffBtn.onclick = ()=> { const ev=getevents(); const i=ev.findIndex(x=>x.id===id); if(i>=0){ delete ev[i].bandOff; setevents(ev); renderCalendar(); renderevents(); showGigDetail(id,false);} };
      holdBtn.onclick = ()=> { const ev=getevents(); const i=ev.findIndex(x=>x.id===id); if(i>=0){ ev[i].hold=true; setevents(ev); renderCalendar(); renderevents(); showGigDetail(id,false);} };
      clearHoldBtn.onclick = ()=> { const ev=getevents(); const i=ev.findIndex(x=>x.id===id); if(i>=0){ delete ev[i].hold; setevents(ev); renderCalendar(); renderevents(); showGigDetail(id,false);} };

      // edit handlers
      editGigBtn.onclick = ()=> enterEditMode(g);
      deleteGigBtn.onclick = ()=> {
        if (!confirm('Delete this event?')) return;
        const ev=getevents().filter(x=> x.id!==id);
        setevents(ev); renderCalendar(); renderevents(); gigModal.close();
      };

      // modes
      gigView.classList.remove('hidden');
      gigEdit.classList.add('hidden');
      saveGigBtn.classList.add('hidden');
      cancelEditBtn.classList.add('hidden');

      document.getElementById('shareHint').classList.add('hidden');
      gigModal.showModal();
      if (pushHash) location.hash = `gig-${id}`;
    };

    function enterEditMode(g){
      const isAdmin = adminLoggedIn();
      if (!isAdmin) return alert('Admin login required.');

      egTitle.value = g.title||'';
      egDate.value = g.date||'';
      egTime.value = g.startTime||'';
      egVenue.value = g.venue||'';
      egAddress.value = g.address||'';
      egBandOff.checked = !!g.bandOff;
      egHold.checked = !!g.hold;

      egCeremonyOnsite.checked = !!g.ceremonyOnsite;
      egRoomFlip.checked = !!g.roomFlip;
      egGuestArrivalTime.value = g.guestArrivalTime||'';
      egCeremonyGuestArrivalTime.value = g.ceremonyGuestArrivalTime||'';
      egBandArrivalTime.value = g.bandArrivalTime||'';
      egIntroTime.value = g.introTime||'';
      egIntroSong.value = g.introSong||'';

      egCocktails.value = g.cocktails||'';
      egCocktailsSeparate.checked = !!g.cocktailsSeparate;
      egCocktailsBandPlay.checked = !!g.cocktailsBandPlay;

      egFirstDanceSong.value = g.firstDanceSong||'';
      egFirstDancePlay.checked = !!g.firstDancePlay;

      egFatherDaughterSong.value = g.fatherDaughterSong||'';
      egFatherDaughterPlay.checked = !!g.fatherDaughterPlay;

      egMotherSonSong.value = g.motherSonSong||'';
      egMotherSonPlay.checked = !!g.motherSonPlay;

      egMeals.value = g.meals||'';
      egLastSong.value = g.lastSong||'';
      egSpecialRequests.value = g.specialRequests||'';
      egDoNotPlay.value = g.doNotPlay||'';

      // conditional row
      egCeremonyGuestArrivalRow.classList.toggle('hidden', !egCeremonyOnsite.checked);
      egCeremonyOnsite.onchange = ()=> egCeremonyGuestArrivalRow.classList.toggle('hidden', !egCeremonyOnsite.checked);

      gigView.classList.add('hidden');
      gigEdit.classList.remove('hidden');
      saveGigBtn.classList.remove('hidden');
      cancelEditBtn.classList.remove('hidden');

      saveGigBtn.onclick = ()=>{
        const ev = getevents();
        const i = ev.findIndex(x=> x.id===g.id);
        if (i>=0){
          ev[i] = {
            ...ev[i],
            title: egTitle.value.trim() || 'Untitled',
            date: egDate.value,
            startTime: egTime.value,
            venue: egVenue.value.trim(),
            address: egAddress.value.trim(),
            bandOff: !!egBandOff.checked,
            hold: !!egHold.checked,
            ceremonyOnsite: !!egCeremonyOnsite.checked,
            roomFlip: !!egRoomFlip.checked,
            guestArrivalTime: egGuestArrivalTime.value,
            ceremonyGuestArrivalTime: egCeremonyOnsite.checked ? egCeremonyGuestArrivalTime.value : '',
            bandArrivalTime: egBandArrivalTime.value,
            introTime: egIntroTime.value,
            introSong: egIntroSong.value.trim(),
            cocktails: egCocktails.value.trim(),
            cocktailsSeparate: !!egCocktailsSeparate.checked,
            cocktailsBandPlay: !!egCocktailsBandPlay.checked,
            firstDanceSong: egFirstDanceSong.value.trim(),
            firstDancePlay: !!egFirstDancePlay.checked,
            fatherDaughterSong: egFatherDaughterSong.value.trim(),
            fatherDaughterPlay: !!egFatherDaughterPlay.checked,
            motherSonSong: egMotherSonSong.value.trim(),
            motherSonPlay: !!egMotherSonPlay.checked,
            meals: egMeals.value.trim(),
            lastSong: egLastSong.value.trim(),
            specialRequests: egSpecialRequests.value.trim(),
            doNotPlay: egDoNotPlay.value.trim()
          };
          setevents(ev);
          renderCalendar(); renderevents(); showGigDetail(g.id, false);
        }
      };
      cancelEditBtn.onclick = ()=> { gigEdit.classList.add('hidden'); gigView.classList.remove('hidden'); saveGigBtn.classList.add('hidden'); cancelEditBtn.classList.add('hidden'); };
    }

    function shareGig(id){
      const url = `${location.origin}${location.pathname}#gig-${id}`;
      navigator.clipboard?.writeText(url).then(()=>{
        document.getElementById('shareHint').classList.remove('hidden');
        setTimeout(()=> document.getElementById('shareHint').classList.add('hidden'), 1500);
      });
    }
    window.addEventListener('hashchange', handleHashOpen);
    function handleHashOpen(){
      const g = location.hash.match(/#gig-(\d+)/);
      const y = location.hash.match(/#yt-([a-z0-9-]+)/i);
      if (g){ const id = parseInt(g[1],10); showGigDetail(id, false); }
      if (y){ const id = y[1]; const item = ytGetRepo().find(x=> x.id===id); if (item) ytOpen(item, false); }
    }
    if (location.hash) handleHashOpen();
    closeGigModal.onclick = ()=> { gigModal.close(); if (location.hash.startsWith('#gig-')) history.replaceState(null,'',location.pathname+location.search); };

    /* ===== New event ===== */
    addGigBtn.onclick = ()=> {
      if (!adminLoggedIn()) return alert('Admin login required.');
      // reset fields
      ngTitle.value=''; ngDate.value=''; ngTime.value=''; ngVenue.value=''; ngAddress.value='';
      ngBandOff.checked=false; ngHold.checked=false;
      ngCeremonyOnsite.checked=false; ngRoomFlip.checked=false;
      ngGuestArrivalTime.value=''; ngCeremonyGuestArrivalTime.value='';
      ngBandArrivalTime.value=''; ngIntroTime.value=''; ngIntroSong.value='';
      ngCocktails.value=''; ngCocktailsSeparate.checked=false; ngCocktailsBandPlay.checked=false;
      ngFirstDanceSong.value=''; ngFirstDancePlay.checked=false;
      ngFatherDaughterSong.value=''; ngFatherDaughterPlay.checked=false;
      ngMotherSonSong.value=''; ngMotherSonPlay.checked=false;
      ngMeals.value=''; ngLastSong.value=''; ngSpecialRequests.value=''; ngDoNotPlay.value='';
      ngCeremonyGuestArrivalRow.classList.add('hidden');
      newGigModal.showModal();
    };
    document.getElementById('closeNewGigModal').onclick = ()=> newGigModal.close();
    ngCeremonyOnsite.onchange = ()=> ngCeremonyGuestArrivalRow.classList.toggle('hidden', !ngCeremonyOnsite.checked);
    createGigBtn.onclick = ()=>{
      const ev = getevents();
      const nextId = (ev.reduce((m,g)=> Math.max(m,g.id), 0) || 0) + 1;
      ev.push({
        id: nextId,
        title: (ngTitle.value||'Untitled').trim(),
        date: ngDate.value,
        startTime: ngTime.value,
        venue: (ngVenue.value||'').trim(),
        address: (ngAddress.value||'').trim(),
        bandOff: !!ngBandOff.checked,
        hold: !!ngHold.checked,
        ceremonyOnsite: !!ngCeremonyOnsite.checked,
        roomFlip: !!ngRoomFlip.checked,
        guestArrivalTime: ngGuestArrivalTime.value,
        ceremonyGuestArrivalTime: ngCeremonyOnsite.checked ? ngCeremonyGuestArrivalTime.value : '',
        bandArrivalTime: ngBandArrivalTime.value,
        introTime: ngIntroTime.value,
        introSong: (ngIntroSong.value||'').trim(),
        cocktails: (ngCocktails.value||'').trim(),
        cocktailsSeparate: !!ngCocktailsSeparate.checked,
        cocktailsBandPlay: !!ngCocktailsBandPlay.checked,
        firstDanceSong: (ngFirstDanceSong.value||'').trim(),
        firstDancePlay: !!ngFirstDancePlay.checked,
        fatherDaughterSong: (ngFatherDaughterSong.value||'').trim(),
        fatherDaughterPlay: !!ngFatherDaughterPlay.checked,
        motherSonSong: (ngMotherSonSong.value||'').trim(),
        motherSonPlay: !!ngMotherSonPlay.checked,
        meals: (ngMeals.value||'').trim(),
        lastSong: (ngLastSong.value||'').trim(),
        specialRequests: (ngSpecialRequests.value||'').trim(),
        doNotPlay: (ngDoNotPlay.value||'').trim(),
        payments: {}
      });
      setevents(ev);
      newGigModal.close();
      renderCalendar(); renderevents();
      showGigDetail(nextId);
    };

    /* ===== Chat ===== */
    function renderChat(){
      chatMessagesEl.innerHTML = '';
      if (chatMessages.length === 0) {
        chatMessagesEl.innerHTML = '<div class="text-slate-400 text-sm">No messages yet. Start the conversation!</div>';
        return;
      }
      chatMessages.forEach(m=>{
        const div = document.createElement('div');
        div.className='chat-msg';
        div.innerHTML = `
          <div><span class="font-semibold text-orange-400">${m.name||'Guest'}</span>
          <span class="subtle ml-2">${m.time||''}</span></div>
          <div>${m.message}</div>`;
        chatMessagesEl.appendChild(div);
      });
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }
    sendChat.onclick = ()=>{
      const msg = (chatInput.value||'').trim(); if(!msg) return;
      const name = (chatName.value||'Guest').trim();
      const time = new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
      chatMessages.push({ name, message: msg, time });
      chatInput.value='';
      localStorage.setItem('ct_chat_v1', JSON.stringify(chatMessages));
      renderChat();
    };
    chatInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendChat.click(); });
    clearChatBtn.onclick = ()=>{
      if (!adminLoggedIn()) return alert('Admin login required.');
      if (!confirm('Clear all chat messages?')) return;
      chatMessages = [];
      localStorage.setItem('ct_chat_v1', JSON.stringify(chatMessages));
      renderChat();
    };

    /* ===== Payments ===== */
    function renderPayments(){
      const events = getevents();
      const isAdmin = adminLoggedIn();
      const me = getCurrentMember();
      const fmt = v => `$${(v||0).toFixed(2)}`;

      if (isAdmin){
        const totals = {};
        BAND_MEMBERS.forEach(m=> totals[m] = events.reduce((sum,g)=> sum + (g.payments?.[m]?.amount || 0), 0));
        ytdSummary.innerHTML = '';
        BAND_MEMBERS.forEach(m=>{
          const card = document.createElement('div');
          card.className = 'ytd-card';
          card.innerHTML = `
            <div class="text-sm">${MEMBER_NAMES[m]}</div>
            <div class="text-2xl font-bold text-orange-400">${fmt(totals[m])}</div>
            <div class="text-xs subtle mt-1">YTD 2025</div>`;
          ytdSummary.appendChild(card);
        });

        paymentsList.innerHTML = '';
        if (events.length === 0) {
          paymentsList.innerHTML = '<div class="text-slate-400 text-sm">No events with payments yet.</div>';
          return;
        }
        events.forEach(g=>{
          const div = document.createElement('div'); div.className='payment-gig';
          let inner = '<div class="grid grid-cols-2 md:grid-cols-5 gap-2 mt-2">';
          BAND_MEMBERS.forEach(m=>{
            const p = g.payments?.[m] || {amount:0,paid:false};
            inner += `
              <div class="text-center">
                <div class="text-xs subtle">${MEMBER_NAMES[m]}</div>
                <div class="font-bold">${fmt(p.amount)}</div>
                <div class="payment-status ${p.paid?'paid':'unpaid'}">${p.paid?'‚úì Event Paid':'Event Owed'}</div>
              </div>`;
          });
          inner += '</div>';
          div.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <div>
                <div class="font-bold">${g.title}</div>
                <div class="text-sm subtle">${g.date}${g.venue? ' ‚Ä¢ '+g.venue : ''}</div>
              </div>
              <span class="text-xs subtle">Admin view</span>
            </div>${inner}`;
          paymentsList.appendChild(div);
        });
        return;
      }

      // User view
      if (!me){
        ytdSummary.innerHTML = '';
        paymentsList.innerHTML = `
          <div class="payment-gig">
            <div class="text-sm subtle">
              Choose your profile to see your payments. Click <strong>"Set My Profile"</strong> at the top.
            </div>
          </div>`;
        return;
      }

      const myYTD = events.reduce((sum,g)=> sum + (g.payments?.[me]?.amount || 0), 0);
      ytdSummary.innerHTML = '';
      const myCard = document.createElement('div');
      myCard.className = 'ytd-card';
      myCard.innerHTML = `
        <div class="text-sm">${MEMBER_NAMES[me]}</div>
        <div class="text-2xl font-bold text-orange-400">${fmt(myYTD)}</div>
        <div class="text-xs subtle mt-1">YTD 2025</div>`;
      ytdSummary.appendChild(myCard);

      paymentsList.innerHTML = '';
      const myEvents = events.filter(g => g.payments?.[me]);
      if (myEvents.length === 0) {
        paymentsList.innerHTML = '<div class="text-slate-400 text-sm">No payments assigned yet.</div>';
        return;
      }
      myEvents.forEach(g=>{
        const p = g.payments?.[me];
        if (!p) return;
        const statusClass = p.paid ? 'paid' : 'unpaid';
        const statusText  = p.paid ? '‚úì Event Paid' : 'Event Owed';

        const div = document.createElement('div'); div.className='payment-gig';
        div.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="font-bold">${g.title}</div>
              <div class="text-sm subtle">${g.date}${g.venue? ' ‚Ä¢ '+g.venue : ''}</div>
            </div>
            <div class="text-right">
              <div class="font-bold">${fmt(p.amount)}</div>
              <div class="payment-status ${statusClass}">${statusText}</div>
            </div>
          </div>`;
        paymentsList.appendChild(div);
      });
    }

    /* ===== Charts Repo (local) ===== */
    const REPO_KEY = 'ct_pdf_repo_v2_public';
    function getRepo(){ try{ return JSON.parse(localStorage.getItem(REPO_KEY)) || []; }catch{ return []; } }
    function setRepo(arr){ localStorage.setItem(REPO_KEY, JSON.stringify(arr)); }

    function hydrateUploaderFilter(){
      const repo = getRepo();
      const names = Array.from(new Set(repo.map(f=> f.uploaderName || 'Guest')));
      uploaderFilter.innerHTML = '<option value="">All uploaders</option>';
      names.forEach(n=>{ const opt=document.createElement('option'); opt.value=n; opt.textContent=n; uploaderFilter.appendChild(opt); });
    }

    function renderRepo(){
      const q = (searchPdf.value||'').toLowerCase();
      const u = uploaderFilter.value || '';
      const repo = getRepo().sort((a,b)=> b.ts - a.ts);
      const filtered = repo.filter(item=>{
        const text = `${item.name} ${item.notes||''}`.toLowerCase();
        const matchesQ = !q || text.includes(q);
        const matchesU = !u || (item.uploaderName||'Guest') === u;
        return matchesQ && matchesU;
      });

      pdfList.innerHTML = '';
      emptyRepo.classList.toggle('hidden', filtered.length !== 0);

      filtered.forEach(item=>{
        const card = document.createElement('div');
        card.className = 'card p-4';
        const sizeKB = Math.round(item.size/1024);
        const when = new Date(item.ts).toLocaleString();
        const canDelete = item.deviceId === deviceId;

        card.innerHTML = `
          <div>
            <div class="font-semibold">${item.name}</div>
            <div class="text-xs subtle mt-1">
              ${item.notes ? `<span class="pill mr-2">${item.notes}</span>` : ''}
              <span class="pill">by ${item.uploaderName||'Guest'}</span>
              <span class="pill">${sizeKB} KB</span>
              <span class="pill">${when}</span>
            </div>
          </div>
          <div class="repo-actions mt-3">
            <button class="btn-dark" data-act="view">View</button>
            <a class="btn-dark" data-act="download" download="${item.name}">Download</a>
            ${canDelete ? '<button class="btn-dark" data-act="delete">Delete</button>' : ''}
          </div>
        `;
        const viewBtn = card.querySelector('[data-act="view"]');
        const dlBtn   = card.querySelector('[data-act="download"]');
        const delBtn  = card.querySelector('[data-act="delete"]');

        viewBtn.onclick = ()=> openPdfModal(item);
        dlBtn.href = item.dataUrl;
        if (delBtn){
          delBtn.onclick = async ()=>{
            const stored = localStorage.getItem(PASS_KEYS.user);
            if (stored){
              const tryPass = prompt('Enter your passcode to delete');
              if (!tryPass || stored !== await sha256(tryPass)) return alert('Wrong passcode.');
            }
            const next = getRepo().filter(x=> x.id !== item.id);
            setRepo(next); hydrateUploaderFilter(); renderRepo();
          };
        }
        pdfList.appendChild(card);
      });
    }

    function openPdfModal(item){
      pdfModalTitle.textContent = item.name;
      pdfMeta.textContent = `${item.uploaderName||'Guest'} ‚Ä¢ ${(item.size/1024|0)} KB ‚Ä¢ ${new Date(item.ts).toLocaleString()}${item.notes? ' ‚Ä¢ '+item.notes:''}`;
      pdfObject.data = item.dataUrl;
      pdfDownloadBtn.href = item.dataUrl;
      pdfDownloadBtn.download = item.name;
      pdfModal.showModal();
    }
    closePdfModal.onclick = ()=> pdfModal.close();

    uploadPdfBtn.onclick = async ()=>{
      const files = Array.from(pdfInput.files||[]);
      if (!files.length){ alert('Select one or more PDF files.'); return; }
      const repo = getRepo();
      for (const f of files){
        if (f.type !== 'application/pdf'){ alert(`'${f.name}' is not a PDF.`); continue; }
        const dataUrl = await fileToDataUrl(f);
        const entry = { id: crypto.randomUUID(), name: f.name, size: f.size, notes: (pdfTitle.value||'').trim(),
          uploaderName: (uploaderName.value||'Guest').trim() || 'Guest', deviceId, ts: Date.now(), dataUrl };
        repo.push(entry);
      }
      setRepo(repo);
      pdfInput.value=''; pdfTitle.value='';
      hydrateUploaderFilter(); renderRepo();
    };

    function fileToDataUrl(file){
      return new Promise((resolve,reject)=>{
        const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file);
      });
    }

    clearFiltersBtn.onclick = ()=>{ searchPdf.value=''; uploaderFilter.value=''; renderRepo(); };
    exportRepoBtn.onclick = ()=>{
      const index = getRepo().map(({id,name,size,uploaderName,notes,ts})=>({id,name,size,uploaderName,notes,ts}));
      const blob = new Blob([JSON.stringify(index,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='charts_index.json'; a.click(); URL.revokeObjectURL(url);
    };

    /* ===== YouTube Repo (local) ===== */
    const YT_KEY = 'ct_yt_repo_v1';
    function ytGetRepo(){ try{ return JSON.parse(localStorage.getItem(YT_KEY)) || []; }catch{ return []; } }
    function ytSetRepo(arr){ localStorage.setItem(YT_KEY, JSON.stringify(arr)); }

    function parseYouTubeId(input){
      if (!input) return null; input=input.trim();
      if (/^[a-zA-Z0-9_-]{11}$/.test(input)) return input;
      const m = input.match(/(?:v=|\/embed\/|\/shorts\/|youtu\.be\/)([a-zA-Z0-9_-]{11})/) || input.match(/v=([a-zA-Z0-9_-]{11})/);
      return m ? m[1] : null;
    }

    function ytHydrateUploaderFilter(){
      const repo = ytGetRepo();
      const names = Array.from(new Set(repo.map(f=> f.uploaderName || 'Guest')));
      ytUploaderFilter.innerHTML = '<option value="">All uploaders</option>';
      names.forEach(n=>{ const opt=document.createElement('option'); opt.value=n; opt.textContent=n; ytUploaderFilter.appendChild(opt); });
    }

    function ytRenderRepo(){
      const q = (ytSearch.value||'').toLowerCase();
      const u = ytUploaderFilter.value || '';
      const repo = ytGetRepo().sort((a,b)=> b.ts - a.ts);
      const filtered = repo.filter(item=>{
        const text = `${item.title||''} ${item.notes||''}`.toLowerCase();
        const matchesQ = !q || text.includes(q);
        const matchesU = !u || (item.uploaderName||'Guest') === u;
        return matchesQ && matchesU;
      });

      ytList.innerHTML = '';
      ytEmpty.classList.toggle('hidden', filtered.length !== 0);

      filtered.forEach(item=>{
        const thumb = `https://i.ytimg.com/vi/${item.videoId}/hqdefault.jpg`;
        const canDelete = item.deviceId === deviceId;

        const card = document.createElement('div');
        card.className = 'card p-3';
        card.innerHTML = `
          <div class="rounded overflow-hidden">
            <img src="${thumb}" alt="Thumbnail" class="w-full" loading="lazy">
          </div>
          <div class="mt-2 font-semibold">${item.title || 'YouTube Video'}</div>
          <div class="text-xs subtle mt-1">
            ${item.notes ? `<span class="pill mr-2">${item.notes}</span>` : ''}
            <span class="pill">by ${item.uploaderName||'Guest'}</span>
            <span class="pill">${new Date(item.ts).toLocaleString()}</span>
          </div>
          <div class="repo-actions mt-3">
            <button class="btn-dark" data-act="play">Play</button>
            <a class="btn-dark" data-act="open" href="https://youtu.be/${item.videoId}" target="_blank" rel="noopener">Open</a>
            <button class="btn-dark" data-act="share">Share</button>
            ${canDelete ? '<button class="btn-dark" data-act="delete">Delete</button>' : ''}
          </div>`;

        const playBtn = card.querySelector('[data-act="play"]');
        const shareBtn = card.querySelector('[data-act="share"]');
        const delBtn = card.querySelector('[data-act="delete"]');

        playBtn.onclick = ()=> ytOpen(item);
        shareBtn.onclick = ()=> ytShare(item);
        if (delBtn){
          delBtn.onclick = async ()=>{
            const stored = localStorage.getItem(PASS_KEYS.user);
            if (stored){
              const tryPass = prompt('Enter your passcode to delete');
              if (!tryPass || stored !== await sha256(tryPass)) return alert('Wrong passcode.');
            }
            ytSetRepo(ytGetRepo().filter(x=> x.id !== item.id));
            ytHydrateUploaderFilter(); ytRenderRepo();
          };
        }
        ytList.appendChild(card);
      });
    }

    function ytOpen(item, pushHash = true){
      ytModalTitle.textContent = item.title || 'YouTube';
      ytIframe.src = `https://www.youtube.com/embed/${item.videoId}?rel=0`;
      ytMeta.textContent = `${item.uploaderName||'Guest'} ‚Ä¢ ${new Date(item.ts).toLocaleString()}${item.notes? ' ‚Ä¢ '+item.notes:''}`;
      ytShareBtn.onclick = ()=> ytShare(item);
      ytShareHint.classList.add('hidden');
      ytModal.showModal();
      if (pushHash) location.hash = `yt-${item.id}`;
    }
    function ytShare(item){
      const url = `${location.origin}${location.pathname}#yt-${item.id}`;
      navigator.clipboard?.writeText(url).then(()=>{
        ytShareHint.classList.remove('hidden');
        setTimeout(()=> ytShareHint.classList.add('hidden'), 1500);
      });
    }
    ytCloseBtn.onclick = ()=>{
      ytIframe.src = '';
      ytModal.close();
      if (location.hash.startsWith('#yt-')) history.replaceState(null,'',location.pathname+location.search);
    };

    addYtBtn.onclick = ()=>{
      const id = parseYouTubeId(ytUrl.value);
      if (!id){ alert('Please enter a valid YouTube URL or 11-character video ID.'); return; }
      const repo = ytGetRepo();
      const item = { id: crypto.randomUUID(), videoId: id, title:(ytTitle.value||'').trim(), notes:(ytNotes.value||'').trim(),
                     uploaderName:(ytUploader.value||'Guest').trim() || 'Guest', deviceId, ts: Date.now() };
      repo.push(item);
      ytSetRepo(repo);
      ytUrl.value=''; ytTitle.value=''; ytNotes.value='';
      ytHydrateUploaderFilter(); ytRenderRepo();
    };

    ytSearch.addEventListener('input', ytRenderRepo);
    ytUploaderFilter.addEventListener('change', ytRenderRepo);
    ytClearFilters.onclick = ()=>{ ytSearch.value=''; ytUploaderFilter.value=''; ytRenderRepo(); };
    ytExportBtn.onclick = ()=>{
      const index = ytGetRepo().map(({id,videoId,title,notes,uploaderName,ts})=>({id,videoId,title,notes,uploaderName,ts}));
      const blob = new Blob([JSON.stringify(index,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='youtube_index.json'; a.click(); URL.revokeObjectURL(url);
    };

    /* ===== Pass & Admin login ===== */
    setPassBtn.onclick = ()=> passModal.showModal();
    closePassBtn.onclick = ()=> passModal.close();
    savePassBtn.onclick = async ()=>{
      const u = document.getElementById('userPass').value.trim();
      const a = document.getElementById('adminPass').value.trim();
      await setPasscodes({ user: u || null, admin: a || null });
      document.getElementById('userPass').value=''; document.getElementById('adminPass').value='';
      passModal.close();
    };

    adminLoginBtn.onclick = ()=>{
      if (!localStorage.getItem(PASS_KEYS.admin)) return alert('Set an admin passcode first (üîí Set Passcode).');
      adminLoginInput.value=''; adminLoginModal.showModal();
    };
    adminLoginClose.onclick = ()=> adminLoginModal.close();
    adminLoginSubmit.onclick = async ()=>{
      const stored = localStorage.getItem(PASS_KEYS.admin);
      const tryPass = adminLoginInput.value.trim();
      if (!tryPass) return;
      const ok = stored === await sha256(tryPass);
      if (!ok) return alert('Incorrect admin passcode.');
      localStorage.setItem(PASS_KEYS.adminSession, '1');
      adminLoginModal.close();
      updateLockStatusUI();
      renderevents(); renderCalendar(); renderPayments();
    };
    adminLogoutBtn.onclick = ()=>{
      localStorage.removeItem(PASS_KEYS.adminSession);
      updateLockStatusUI();
      renderevents(); renderCalendar(); renderPayments();
    };

    /* ===== Profile modal ===== */
    setProfileBtn.onclick = ()=>{
      profileSelect.value = getCurrentMember();
      profileModal.showModal();
    };
    saveProfileBtn.onclick = ()=>{
      setCurrentMember(profileSelect.value);
      profileModal.close();
      renderPayments();
    };
    closeProfileBtn.onclick = ()=> profileModal.close();

    /* ===== Init ===== */
    function init(){
      updateLockStatusUI();
      updateProfileStatus();
      renderCalendar();
      renderevents();
    }
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
